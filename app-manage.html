<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Application Management</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css">
    <style>
        :root {
            --background-color: #f8fafc;
            --card-background: #fff;
            --text-color: #334155;
            --heading-color: #1e293b;
            --secondary-text: #64748b;
            --border-color: #e2e8f0;
            --input-border: #cbd5e1;
            --input-background: #fff;
            --shadow-color: rgba(0,0,0,0.05);
            --primary-color: #3b82f6;
            --primary-hover: #2563eb;
            --danger-color: #ef4444;
            --danger-hover: #dc2626;
            --section-bg: #f1f5f9;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --tab-active-border: #3b82f6;
            --info-color: #0ea5e9;
        }

        [data-theme="dark"] {
            --background-color: #0f172a;
            --card-background: #1e293b;
            --text-color: #cbd5e1;
            --heading-color: #f1f5f9;
            --secondary-text: #94a3b8;
            --border-color: #334155;
            --input-border: #475569;
            --input-background: #334155;
            --shadow-color: rgba(0,0,0,0.3);
            --primary-color: #60a5fa;
            --primary-hover: #93c5fd;
            --danger-color: #ef4444;
            --danger-hover: #f87171;
            --section-bg: #2d3748;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --tab-active-border: #60a5fa;
            --info-color: #38bdf8;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            height: 100%;
            min-height: 100vh;
            width: 100vw;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #232946 100%) fixed !important;
            color: var(--text-color);
            box-sizing: border-box;
            font-family: 'Poppins', 'Segoe UI', Arial, sans-serif;
        }
        body {
            position: relative;
            min-height: 100vh;
            width: 100vw;
            margin: 0;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow-x: hidden;
            overflow-y: auto;
        }
        #root, .container, .card, .info-item, .confirmation-modal, .create-app-form, .tab-content, .table-container, .app-header, .tab-nav, .tab-button, .tab-content.active {
            background: none !important;
        }
        .container {
            max-width: 480px;
            width: 99%;
            margin: 24px auto;
            padding: 8px 4px;
            border-radius: 12px;
        }
        .card, .info-item, .confirmation-modal, .create-app-form, .tab-content, .table-container {
            background: rgba(30,41,59,0.85) !important;
            box-shadow: 0 4px 24px #23294655;
            border: 1.5px solid #334155;
        }
        button, .btn, .tab-button, .delete-btn, .manage-btn, .logout-btn {
            background: linear-gradient(90deg, #60a5fa 0%, #232946 100%) !important;
            color: #fff !important;
            border: none;
        }
        button:hover, .btn:hover, .tab-button:hover, .delete-btn:hover, .manage-btn:hover, .logout-btn:hover {
            background: linear-gradient(90deg, #232946 0%, #60a5fa 100%) !important;
            color: #fff !important;
        }
        input[type="text"], input[type="email"], input[type="password"], input[type="number"], select:focus {
            border: 2px solid #60a5fa;
            box-shadow: 0 0 0 4px #60a5fa33;
            background: #232946;
            color: #fff;
        }
        .theme-switch-label {
            color: #60a5fa;
        }
        .blob {
            background: linear-gradient(135deg, #232946 0%, #60a5fa 100%);
            opacity: 0.18;
            z-index: 1;
        }
        
        .container {
            border: 1px solid var(--border-color);
            padding: 15px 20px;
            border-radius: 0;
            background-color: var(--card-background);
            box-shadow: 0 4px 20px var(--shadow-color);
            width: 100%;
            height: 100vh;
            max-height: 100vh;
            overflow-y: auto;
            transition: all 0.3s ease;
            animation: fadeIn 0.5s ease-in-out;
            margin: 0;
            border: none;
            position: fixed; /* Keep the container fixed in place */
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }
        
        @media (min-width: 768px) {
            .container {
                padding: 20px 25px;
            }
        }
        
        @media (min-width: 1200px) {
            .container {
                padding: 25px 30px;
            }
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(96, 165, 250, 0.2);
            position: relative;
        }
        
        .header::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 100px;
            height: 3px;
            background: linear-gradient(90deg, #60a5fa, transparent);
            border-radius: 3px;
        }
        
        .header h2 {
            font-size: 2rem;
            font-weight: 800;
            background: linear-gradient(90deg, #60a5fa 0%, #a5b4fc 50%, #818cf8 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: 0.5px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .header h2 svg {
            width: 36px;
            height: 36px;
            fill: #60a5fa;
            filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.3));
        }
        
        .app-name {
            color: #f1f5f9;
            font-weight: 700;
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            position: relative;
            display: inline-block;
        }
        
        .app-name::after {
            content: '';
            position: absolute;
            bottom: -4px;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, #60a5fa, transparent);
            border-radius: 2px;
        }

        .controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        button {
            background-color: var(--primary-color);
            color: white;
            padding: 8px 14px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            font-family: 'Poppins', sans-serif;
            background-image: linear-gradient(to right, var(--primary-color), var(--primary-hover));
        }
        
        button:hover {
            background-color: var(--primary-hover);
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(96, 165, 250, 0.3);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .back-btn {
            background: rgba(30, 41, 59, 0.6) !important;
            color: #f1f5f9 !important;
            border: 1px solid rgba(96, 165, 250, 0.3);
            padding: 10px 16px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .back-btn:hover {
            background: rgba(51, 65, 85, 0.8) !important;
            border-color: rgba(96, 165, 250, 0.5);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }
        
        .back-btn svg {
            width: 16px;
            height: 16px;
            stroke: currentColor;
            transition: transform 0.3s ease;
        }
        
        .back-btn:hover svg {
            transform: translateX(-3px);
        }
        
        .tab-nav {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
            gap: 8px;
        }
        
        .tab-button {
            background: none;
            border: none;
            padding: 10px 18px;
            font-size: 12px;
            font-weight: 500;
            color: var(--secondary-text);
            cursor: pointer;
            position: relative;
            transition: all 0.3s;
            box-shadow: none;
        }
        
        .tab-button:hover {
            color: var(--heading-color);
            background: none;
            box-shadow: none;
            transform: none;
        }
        
        .tab-button.active {
            color: var(--primary-color);
        }
        
        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 100%;
            height: 2px;
            background-color: var(--tab-active-border);
        }
        
        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: var(--text-color);
            font-size: 14px;
        }
        
        input[type="text"], 
        input[type="email"], 
        input[type="password"],
        input[type="number"],
        select {
            width: 100%;
            padding: 10px 14px;
            box-sizing: border-box;
            border: 1px solid var(--input-border);
            border-radius: 8px;
            background-color: var(--input-background);
            color: var(--text-color);
            font-size: 15px;
            transition: all 0.3s;
            font-family: 'Poppins', sans-serif;
        }
        
        input:focus,
        select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.4);
        }

        .card {
            padding: 24px;
            border-radius: 16px;
            margin-bottom: 24px;
            transition: all 0.3s ease;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(96, 165, 250, 0.15);
            position: relative;
            overflow: hidden;
            background: rgba(30, 41, 59, 0.75) !important;
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, #60a5fa, transparent);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .card:hover::before {
            opacity: 1;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.25), 0 0 15px rgba(96, 165, 250, 0.15);
            border-color: rgba(96, 165, 250, 0.3);
        }
        
        .card h3 {
            margin-bottom: 25px;
            color: #f1f5f9;
            font-size: 1.25rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
            position: relative;
            padding-bottom: 15px;
        }
        
        .card h3::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 60px;
            height: 2px;
            background: linear-gradient(90deg, #60a5fa, transparent);
            border-radius: 2px;
        }
        
        .card h3 svg {
            width: 24px;
            height: 24px;
            fill: #60a5fa;
            filter: drop-shadow(0 2px 5px rgba(0, 0, 0, 0.2));
        }

        .table-container {
            overflow-x: auto;
            margin: 20px 0;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            text-align: left;
            padding: 12px 15px;
            font-weight: 600;
            color: var(--secondary-text);
            border-bottom: 1px solid var(--border-color);
        }
        
        td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        tr:last-child td {
            border-bottom: none;
        }
        
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-col {
            flex: 1;
        }
        
        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .badge-success {
            background-color: rgba(16, 185, 129, 0.2);
            color: var(--success-color);
        }
        
        .badge-warning {
            background-color: rgba(245, 158, 11, 0.2);
            color: var(--warning-color);
        }
        
        .badge-danger {
            background-color: rgba(239, 68, 68, 0.2);
            color: var(--danger-color);
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--secondary-text);
        }
        
        .empty-state svg {
            width: 60px;
            height: 60px;
            fill: var(--secondary-text);
            margin-bottom: 15px;
            opacity: 0.5;
        }
        
        .empty-state p {
            font-size: 16px;
            margin-bottom: 20px;
        }
        
        .theme-switch {
            display: flex;
            align-items: center;
            margin-left: 15px;
        }
        
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 32px;
            margin: 0;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid rgba(96, 165, 250, 0.3);
            transition: .4s;
            border-radius: 32px;
        }
        
        .slider:before {
            position: absolute;
            content: "ðŸŒœ";
            display: flex;
            align-items: center;
            justify-content: center;
            height: 24px;
            width: 24px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transition: .4s;
            border-radius: 50%;
            font-size: 14px;
        }
        
        input:checked + .slider {
            background: linear-gradient(90deg, #60a5fa, #3b82f6);
            border-color: transparent;
        }
        
        input:focus + .slider {
            box-shadow: 0 0 5px rgba(59, 130, 246, 0.5);
        }
        
        input:checked + .slider:before {
            transform: translateX(28px);
            content: "ðŸŒž";
        }
        
        .theme-switch-label {
            margin-right: 10px;
            font-weight: 600;
            color: #94a3b8;
            font-size: 14px;
            letter-spacing: 0.5px;
        }

        .info-item {
            background-color: var(--section-bg);
            padding: 15px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .info-label {
            font-size: 14px;
            color: var(--secondary-text);
        }
        
        .info-value {
            font-size: 24px;
            font-weight: 600;
            color: var(--heading-color);
        }

        /* User Details Tab Styles */
        .user-license-card {
            padding: 20px;
            border-radius: 12px;
            background-color: var(--section-bg);
            margin-bottom: 20px;
            border-left: 4px solid var(--info-color);
            transition: all 0.3s ease;
        }
        
        .user-license-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        
        .user-license-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .user-license-header h4 {
            font-size: 18px;
            font-weight: 600;
            color: var(--heading-color);
        }
        
        .user-detail-row {
            display: flex;
            margin-bottom: 12px;
        }
        
        .user-detail-label {
            width: 150px;
            font-weight: 500;
            color: var(--secondary-text);
        }
        
        .user-detail-value {
            flex: 1;
            color: var(--text-color);
        }
        
        .user-actions {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .reset-hwid-btn {
            background: linear-gradient(90deg, #ff9800 0%, #f44336 100%) !important;
        }
        
        .reset-hwid-btn:hover {
            background: linear-gradient(90deg, #f44336 0%, #ff9800 100%) !important;
        }
        
        .user-search-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .user-search-input {
            flex: 1;
        }
        
        .search-btn {
            background: linear-gradient(90deg, #0ea5e9 0%, #2563eb 100%) !important;
        }
        
        .search-btn:hover {
            background: linear-gradient(90deg, #2563eb 0%, #0ea5e9 100%) !important;
        }
        
        .hardware-details {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(270px, 1fr));
            gap: 15px;
            margin-top: 20px;
            margin-bottom: 25px;
        }
        
        .hardware-details .detail-item {
            background-color: rgba(14, 165, 233, 0.1);
            padding: 12px 15px;
            border-radius: 10px;
            border-left: 3px solid var(--info-color);
        }
        
        .detail-item .item-label {
            font-size: 13px;
            color: var(--secondary-text);
            margin-bottom: 5px;
        }
        
        .detail-item .item-value {
            font-family: monospace;
            word-break: break-all;
        }
        
        .badge-active {
            background-color: rgba(16, 185, 129, 0.2);
            color: var(--success-color);
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 12px;
        }
        
        .badge-expired {
            background-color: rgba(239, 68, 68, 0.2);
            color: var(--danger-color);
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 12px;
        }
        
        /* Animation for reset action */
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }
        
        .pulse-animation {
            animation: pulse 2s infinite;
        }

        /* Beautiful confirmation dialog */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .confirmation-modal {
            width: 100%;
            max-width: 400px;
            background-color: var(--card-background);
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
            overflow: hidden;
            transform: translateY(20px) scale(0.95);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .modal-overlay.active .confirmation-modal {
            transform: translateY(0) scale(1);
        }

        .confirmation-modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
        }

        .confirmation-modal-icon {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            margin-right: 15px;
            flex-shrink: 0;
        }

        .confirmation-modal-icon.warning {
            background-color: rgba(245, 158, 11, 0.2);
            color: var(--warning-color);
        }

        .confirmation-modal-icon.danger {
            background-color: rgba(239, 68, 68, 0.2);
            color: var(--danger-color);
        }

        .confirmation-modal-icon svg {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }

        .confirmation-modal-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--heading-color);
            flex: 1;
        }

        .confirmation-modal-body {
            padding: 20px;
            color: var(--secondary-text);
            font-size: 15px;
        }

        .confirmation-modal-actions {
            padding: 15px 20px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            border-top: 1px solid var(--border-color);
        }

        .confirmation-modal-actions button {
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .confirmation-modal-actions .cancel-btn {
            background-color: var(--section-bg);
            color: var(--text-color);
            border: none;
        }

        .confirmation-modal-actions .cancel-btn:hover {
            background-color: var(--border-color);
            transform: translateY(-1px);
        }

        .confirmation-modal-actions .confirm-btn {
            background-color: var(--danger-color);
            color: white;
            border: none;
        }

        .confirmation-modal-actions .confirm-btn:hover {
            background-color: var(--danger-hover);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        /* Enhanced Toast Notifications */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            max-width: 350px;
            padding: 0;
            background-color: var(--card-background);
            color: var(--heading-color);
            border-radius: 12px;
            box-shadow: 0 10px 30px var(--shadow-color);
            display: flex;
            flex-direction: column;
            z-index: 1000;
            overflow: hidden;
            transform: translateY(100px);
            opacity: 0;
            pointer-events: none;
            transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.3s ease;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
            pointer-events: auto;
        }

        .toast-header {
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            position: relative;
        }

        .toast-icon {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .toast.success .toast-icon {
            background-color: rgba(16, 185, 129, 0.2);
            color: var(--success-color);
        }

        .toast.error .toast-icon {
            background-color: rgba(239, 68, 68, 0.2);
            color: var(--danger-color);
        }

        .toast.warning .toast-icon {
            background-color: rgba(245, 158, 11, 0.2);
            color: var(--warning-color);
        }

        .toast.info .toast-icon {
            background-color: rgba(14, 165, 233, 0.2);
            color: var(--primary-color);
        }

        .toast-icon svg {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 2px;
            color: var(--heading-color);
        }

        .toast-close {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--section-bg);
            border-radius: 50%;
            cursor: pointer;
            color: var(--secondary-text);
            transition: all 0.2s ease;
        }

        .toast-close:hover {
            background-color: var(--border-color);
            color: var(--heading-color);
        }

        .toast-message {
            padding: 0 20px 15px 20px;
            font-size: 14px;
            color: var(--secondary-text);
            line-height: 1.5;
        }

        .toast-progress {
            height: 3px;
            background-color: var(--primary-color);
            width: 100%;
            transform-origin: left;
            animation: toast-progress 3s linear forwards;
        }

        .toast.success .toast-progress {
            background-color: var(--success-color);
        }

        .toast.error .toast-progress {
            background-color: var(--danger-color);
        }

        .toast.warning .toast-progress {
            background-color: var(--warning-color);
        }

        @keyframes toast-progress {
            from {
                transform: scaleX(1);
            }
            to {
                transform: scaleX(0);
            }
        }

        /* ...existing styles... */
        .custom-modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(20,24,34,0.85);
            backdrop-filter: blur(8px);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
        }
        .custom-modal-overlay.active {
            display: flex;
        }
        .custom-modal {
            background: rgba(30,41,59,0.98);
            border-radius: 24px;
            box-shadow: 0 8px 32px #60a5fa55, 0 2px 8px #0008;
            padding: 40px 32px 32px 32px;
            min-width: 320px;
            max-width: 90vw;
            text-align: center;
            position: relative;
        }
        .custom-modal .modal-icon {
            margin-bottom: 18px;
        }
        .custom-modal .modal-icon svg {
            width: 48px;
            height: 48px;
            fill: #ef4444;
            filter: drop-shadow(0 0 16px #ef4444aa);
        }
        .custom-modal .modal-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #fff;
            margin-bottom: 12px;
        }
        .custom-modal .modal-message {
            color: #cbd5e1;
            margin-bottom: 28px;
        }
        .custom-modal .modal-actions {
            display: flex;
            gap: 18px;
            justify-content: center;
        }
        .custom-modal .modal-btn {
            padding: 12px 28px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 700;
            border: none;
            cursor: pointer;
            transition: box-shadow 0.2s, filter 0.2s, transform 0.2s;
        }
        .custom-modal .modal-btn.cancel {
            background: #232946;
            color: #cbd5e1;
            border: 1.5px solid #334155;
        }
        .custom-modal .modal-btn.cancel:hover {
            background: #334155;
            color: #fff;
        }
        .custom-modal .modal-btn.confirm {
            background: linear-gradient(90deg, #ef4444 0%, #60a5fa 100%);
            color: #fff;
            box-shadow: 0 0 16px #ef444455;
        }
        .custom-modal .modal-btn.confirm:hover {
            background: linear-gradient(90deg, #60a5fa 0%, #ef4444 100%);
            filter: brightness(1.08) drop-shadow(0 0 8px #ef4444);
        }
        /* ...existing styles... */
        .custom-input-modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(20,24,34,0.85);
            backdrop-filter: blur(8px);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
        }
        .custom-input-modal-overlay.active {
            display: flex;
        }
        .custom-input-modal {
            background: rgba(30,41,59,0.98);
            border-radius: 24px;
            box-shadow: 0 8px 32px #60a5fa55, 0 2px 8px #0008;
            padding: 40px 32px 32px 32px;
            min-width: 340px;
            max-width: 95vw;
            text-align: center;
            position: relative;
        }
        .custom-input-modal .modal-icon {
            margin-bottom: 18px;
        }
        .custom-input-modal .modal-icon svg {
            width: 44px;
            height: 44px;
            fill: #60a5fa;
            filter: drop-shadow(0 0 12px #60a5fa99);
        }
        .custom-input-modal .modal-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: #fff;
            margin-bottom: 10px;
        }
        .custom-input-modal .modal-message {
            color: #cbd5e1;
            margin-bottom: 18px;
        }
        .custom-input-modal .modal-input {
            width: 100%;
            padding: 12px 16px;
            border-radius: 10px;
            border: 1.5px solid #334155;
            background: rgba(30,41,59,0.85);
            color: #fff;
            font-size: 1rem;
            margin-bottom: 24px;
            outline: none;
            transition: border 0.2s, box-shadow 0.2s;
        }
        .custom-input-modal .modal-input:focus {
            border: 2px solid #60a5fa;
            box-shadow: 0 0 0 4px #60a5fa33;
            background: #232946;
        }
        .custom-input-modal .modal-actions {
            display: flex;
            gap: 18px;
            justify-content: center;
        }
        .custom-input-modal .modal-btn {
            padding: 12px 28px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 700;
            border: none;
            cursor: pointer;
            transition: box-shadow 0.2s, filter 0.2s, transform 0.2s;
        }
        .custom-input-modal .modal-btn.cancel {
            background: #232946;
            color: #cbd5e1;
            border: 1.5px solid #334155;
        }
        .custom-input-modal .modal-btn.cancel:hover {
            background: #334155;
            color: #fff;
        }
        .custom-input-modal .modal-btn.confirm {
            background: linear-gradient(90deg, #60a5fa 0%, #232946 100%);
            color: #fff;
            box-shadow: 0 0 16px #60a5fa55;
        }
        .custom-input-modal .modal-btn.confirm:hover {
            background: linear-gradient(90deg, #232946 0%, #60a5fa 100%);
            filter: brightness(1.08) drop-shadow(0 0 8px #60a5fa);
        }
        label, .info-label, .detail-label, .form-group label {
            font-size: 0.9rem;
            font-weight: 600;
            color: #cbd5e1;
            letter-spacing: 0.01em;
        }
        input, select, textarea {
            font-size: 1rem;
            color: #f1f5f9;
            font-weight: 500;
        }
        .header h2, .card h3, .tab-button, .modal-title, .app-name, .empty-state p {
            font-weight: 800;
            font-size: 1rem;
            color: #f1f5f9;
            text-shadow: 0 2px 8px #23294655;
            letter-spacing: 0.02em;
        }
        .tab-button {
            font-size: 0.9rem;
            font-weight: 600;
        }
        .badge, .badge-success, .badge-warning, .badge-danger {
            font-size: 0.98rem;
            font-weight: 700;
        }
        .form-group label {
            color: #a1c4fd;
        }
        .modal-title, .modal-message {
            color: #f1f5f9;
        }
        .modal-message {
            font-size: 1rem;
        }
        .empty-state p {
            color: #a1c4fd;
        }
        .table-container th, .table-container td {
            font-size: 1rem;
        }
        .delete-btn, .manage-btn, .logout-btn, .create-app-btn, .create-first-app-btn {
            font-size: 1rem;
            font-weight: 700;
        }
        /* Fix faded/low-contrast text */
        .secondary-text, .info-label, .detail-label {
            color: #a1c4fd !important;
        }

        /* Modern Design Improvements */
        :root {
            --background-color: #f8fafc;
            --card-background: #fff;
            --text-color: #334155;
            --heading-color: #1e293b;
            --secondary-text: #64748b;
            --border-color: #e2e8f0;
            --input-border: #cbd5e1;
            --input-background: #fff;
            --shadow-color: rgba(0,0,0,0.05);
            --primary-color: #3b82f6;
            --primary-hover: #2563eb;
            --danger-color: #ef4444;
            --danger-hover: #dc2626;
            --section-bg: #f1f5f9;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --tab-active-border: #3b82f6;
            --info-color: #0ea5e9;
        }

        [data-theme="dark"] {
            --background-color: #0f172a;
            --card-background: #1e293b;
            --text-color: #cbd5e1;
            --heading-color: #f1f5f9;
            --secondary-text: #94a3b8;
            --border-color: #334155;
            --input-border: #475569;
            --input-background: #334155;
            --shadow-color: rgba(0,0,0,0.3);
            --primary-color: #60a5fa;
            --primary-hover: #93c5fd;
            --danger-color: #ef4444;
            --danger-hover: #f87171;
            --section-bg: #2d3748;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --tab-active-border: #60a5fa;
            --info-color: #38bdf8;
        }

        html, body {
            height: 100%;
            min-height: 100vh;
            width: 100vw;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #232946 100%) fixed !important;
            color: var(--text-color);
            box-sizing: border-box;
            font-family: 'Poppins', 'Segoe UI', Arial, sans-serif;
        }

        /* Animated background elements */
        .animated-bg {
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: 0;
            overflow: hidden;
            pointer-events: none;
        }

        .bg-element {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.15;
            animation: float 20s infinite ease-in-out;
        }

        .bg-element:nth-child(1) {
            width: 500px;
            height: 500px;
            background: radial-gradient(circle at center, #60a5fa 0%, transparent 70%);
            top: -100px;
            right: -100px;
            animation-delay: 0s;
        }

        .bg-element:nth-child(2) {
            width: 400px;
            height: 400px;
            background: radial-gradient(circle at center, #818cf8 0%, transparent 70%);
            bottom: -50px;
            left: 10%;
            animation-delay: -5s;
        }

        .bg-element:nth-child(3) {
            width: 350px;
            height: 350px;
            background: radial-gradient(circle at center, #10b981 0%, transparent 70%);
            top: 30%;
            right: 15%;
            animation-delay: -10s;
        }

        @keyframes float {
            0% { transform: translate(0, 0) rotate(0deg); }
            25% { transform: translate(15px, 15px) rotate(3deg); }
            50% { transform: translate(0, 30px) rotate(0deg); }
            75% { transform: translate(-15px, 15px) rotate(-3deg); }
            100% { transform: translate(0, 0) rotate(0deg); }
        }

        .container {
            background: rgba(15, 23, 42, 0.8) !important;
            box-shadow: 0 16px 50px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(96, 165, 250, 0.2);
            border-radius: 24px;
            position: relative;
            z-index: 2;
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            max-width: 1400px;
            width: 95%;
            margin: 30px auto;
            height: auto;
            min-height: 90vh;
            padding: 30px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(96, 165, 250, 0.2);
        }

        .header h2 {
            font-size: 2.3rem;
            font-weight: 800;
            background: linear-gradient(90deg, #60a5fa 0%, #a5b4fc 50%, #818cf8 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: 0.5px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header h2 svg {
            width: 32px;
            height: 32px;
            fill: #60a5fa;
        }

        .app-name {
            color: #f1f5f9;
            font-weight: 700;
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .card {
            background: rgba(30, 41, 59, 0.5) !important;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(96, 165, 250, 0.15);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.2), 0 0 20px rgba(96, 165, 250, 0.1);
            border: 1px solid rgba(96, 165, 250, 0.3);
        }

        .card h3 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #f1f5f9;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .card h3 svg {
            width: 26px;
            height: 26px;
            fill: #60a5fa;
        }

        .tab-nav {
            display: flex;
            border-bottom: 1px solid rgba(96, 165, 250, 0.2);
            margin-bottom: 30px;
            gap: 10px;
            overflow-x: auto;
            padding-bottom: 1px;
        }

        .tab-button {
            background: transparent !important;
            border: none;
            padding: 12px 22px;
            font-size: 1rem;
            font-weight: 600;
            color: #94a3b8;
            cursor: pointer;
            position: relative;
            transition: all 0.3s;
            white-space: nowrap;
            box-shadow: none !important;
            border-radius: 0;
        }

        .tab-button:hover {
            color: #f1f5f9;
            background: transparent !important;
            transform: none;
        }

        .tab-button.active {
            color: #60a5fa;
            background: transparent !important;
        }

        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, #60a5fa, #818cf8);
            border-radius: 2px;
        }

        button, .btn, .logout-btn, .delete-btn, .manage-btn {
            background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%) !important;
            color: white !important;
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
            font-weight: 600;
            letter-spacing: 0.5px;
            padding: 12px 20px;
            font-size: 1rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        button:before, .btn:before, .logout-btn:before, .delete-btn:before, .manage-btn:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: 0.5s;
        }

        button:hover:before, .btn:hover:before, .logout-btn:hover:before, .delete-btn:hover:before, .manage-btn:hover:before {
            left: 100%;
        }

        button:hover, .btn:hover, .logout-btn:hover, .delete-btn:hover, .manage-btn:hover {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%) !important;
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.5);
        }

        .logout-btn, .delete-btn, .reset-hwid-btn {
            background: linear-gradient(135deg, #f43f5e 0%, #e11d48 100%) !important;
            box-shadow: 0 4px 15px rgba(225, 29, 72, 0.4);
        }

        .logout-btn:hover, .delete-btn:hover, .reset-hwid-btn:hover {
            background: linear-gradient(135deg, #e11d48 0%, #be123c 100%) !important;
            box-shadow: 0 8px 25px rgba(225, 29, 72, 0.5);
        }

        input[type="text"], 
        input[type="email"], 
        input[type="password"],
        input[type="number"],
        input[type="date"],
        select {
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid rgba(96, 165, 250, 0.3);
            border-radius: 10px;
            color: #f1f5f9;
            padding: 12px 16px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        input:focus,
        select:focus {
            border: 1px solid #60a5fa;
            box-shadow: 0 0 0 4px rgba(96, 165, 250, 0.2);
            background: rgba(30, 41, 59, 0.8);
        }

        .table-container {
            border-radius: 12px;
            background: rgba(15, 23, 42, 0.4);
            border: 1px solid rgba(96, 165, 250, 0.15);
            overflow: hidden;
            margin: 25px 0;
        }

        table {
            width: 100%;
            border-spacing: 0;
        }

        th {
            text-align: left;
            padding: 16px 20px;
            font-weight: 600;
            color: #94a3b8;
            border-bottom: 1px solid rgba(96, 165, 250, 0.2);
            background: rgba(15, 23, 42, 0.6);
            font-size: 0.95rem;
            letter-spacing: 0.5px;
        }

        td {
            padding: 14px 20px;
            border-bottom: 1px solid rgba(96, 165, 250, 0.1);
            color: #f1f5f9;
            font-weight: 500;
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover td {
            background-color: rgba(96, 165, 250, 0.05);
        }

        .badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.85rem;
            display: inline-flex;
            align-items: center;
        }

        .badge-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            box-shadow: 0 2px 10px rgba(16, 185, 129, 0.3);
        }

        .badge-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            box-shadow: 0 2px 10px rgba(245, 158, 11, 0.3);
        }

        .badge-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            box-shadow: 0 2px 10px rgba(239, 68, 68, 0.3);
        }

        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .form-col {
            flex: 1;
            min-width: 250px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #a5b4fc;
            font-size: 0.95rem;
            letter-spacing: 0.5px;
        }

        .user-license-card {
            background: rgba(30, 41, 59, 0.5);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 25px;
            border-top: 4px solid #38bdf8;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .user-license-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.2), 0 0 20px rgba(56, 189, 248, 0.1);
            border-top: 4px solid #0ea5e9;
        }

        .hardware-details {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(270px, 1fr));
            gap: 15px;
            margin-top: 25px;
            margin-bottom: 25px;
        }

        .hardware-details .detail-item {
            background: rgba(15, 23, 42, 0.4);
            padding: 15px 20px;
            border-radius: 12px;
            border: 1px solid rgba(14, 165, 233, 0.2);
        }

        .detail-item .item-label {
            font-size: 0.9rem;
            color: #94a3b8;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .detail-item .item-value {
            font-family: 'Consolas', monospace;
            word-break: break-all;
            color: #f1f5f9;
            font-weight: 500;
            font-size: 0.95rem;
            background: rgba(15, 23, 42, 0.5);
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid rgba(14, 165, 233, 0.1);
        }

        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid rgba(96, 165, 250, 0.3);
            border-radius: 12px;
            padding: 16px 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3), 0 0 20px rgba(96, 165, 250, 0.2);
            color: #f1f5f9;
            display: flex;
            align-items: center;
            gap: 15px;
            transform: translateY(100px);
            opacity: 0;
            visibility: hidden;
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            backdrop-filter: blur(10px);
            z-index: 9999;
            min-width: 300px;
            max-width: 450px;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
            visibility: visible;
        }

        .custom-modal-overlay, .custom-input-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(10px);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .custom-modal-overlay.active, .custom-input-modal-overlay.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        .custom-modal, .custom-input-modal {
            background: rgba(30, 41, 59, 0.95);
            border: 1px solid rgba(96, 165, 250, 0.2);
            border-radius: 20px;
            padding: 35px 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3), 0 0 30px rgba(96, 165, 250, 0.2);
            min-width: 360px;
            max-width: 95vw;
            text-align: center;
            position: relative;
            transform: translateY(20px);
            opacity: 0;
            animation: modalSlideUp 0.4s ease forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes modalSlideUp {
            from { 
                transform: translateY(20px);
                opacity: 0;
            }
            to { 
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-icon svg {
            width: 48px;
            height: 48px;
            margin-bottom: 20px;
            fill: #60a5fa;
            filter: drop-shadow(0 0 12px rgba(96, 165, 250, 0.4));
        }

        .custom-modal .modal-icon svg {
            fill: #ef4444;
            filter: drop-shadow(0 0 12px rgba(239, 68, 68, 0.4));
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #f1f5f9;
            margin-bottom: 15px;
        }

        .modal-message {
            color: #cbd5e1;
            margin-bottom: 30px;
            font-size: 1.05rem;
            line-height: 1.6;
        }

        .modal-actions {
            display: flex;
            gap: 20px;
            justify-content: center;
        }

        .modal-btn {
            padding: 12px 28px;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            letter-spacing: 0.5px;
        }

        .modal-btn.cancel {
            background: rgba(30, 41, 59, 0.8);
            color: #cbd5e1;
            border: 1px solid rgba(96, 165, 250, 0.2);
        }

        .modal-btn.cancel:hover {
            background: rgba(51, 65, 85, 0.9);
            color: #f1f5f9;
            transform: translateY(-3px);
        }

        .modal-btn.confirm {
            background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
            color: #fff;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
            border: none;
        }

        .modal-btn.confirm:hover {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.5);
        }

        .custom-modal .modal-btn.confirm {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
        }

        .custom-modal .modal-btn.confirm:hover {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.5);
        }

        .modal-input {
            width: 100%;
            padding: 14px 18px;
            border-radius: 12px;
            border: 1px solid rgba(96, 165, 250, 0.3);
            background: rgba(30, 41, 59, 0.5);
            color: #f1f5f9;
            font-size: 1.05rem;
            margin-bottom: 25px;
            transition: all 0.3s ease;
        }

        .modal-input:focus {
            border: 1px solid #60a5fa;
            box-shadow: 0 0 0 4px rgba(96, 165, 250, 0.2);
            background: rgba(30, 41, 59, 0.8);
            outline: none;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
                border-radius: 0;
                width: 100%;
                margin: 0;
                min-height: 100vh;
            }
            
            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .controls {
                width: 100%;
                flex-wrap: wrap;
                gap: 10px;
            }
            
            .tab-nav {
                padding-bottom: 10px;
            }
            
            .form-row {
                flex-direction: column;
                gap: 15px;
            }
            
            .form-col {
                width: 100%;
            }
            
            .modal-actions {
                flex-direction: column;
            }
        }

        /* Add animated background elements to the body */
        body::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: -1;
        }

        /* Custom Scrollbar Styles */
        ::-webkit-scrollbar {
            width: 10px;
            background: #1e293b;
        }
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #60a5fa 0%, #232946 100%);
            border-radius: 8px;
            border: 2px solid #1e293b;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #232946 0%, #60a5fa 100%);
        }
        ::-webkit-scrollbar-corner {
            background: #1e293b;
        }
        /* Firefox */
        html {
            scrollbar-width: thin;
            scrollbar-color: #60a5fa #1e293b;
        }
        .copy-btn {
            background: none !important;
            border: none;
            color: #60a5fa;
            cursor: pointer;
            padding: 4px 6px;
            border-radius: 6px;
            transition: background 0.2s;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
        }
        .copy-btn:hover {
            background: #23294644;
            color: #93c5fd;
        }

        /* Modern Design Improvements */
        :root {
            --background-color: #f8fafc;
            --card-background: #fff;
            --text-color: #334155;
            --heading-color: #1e293b;
            --secondary-text: #64748b;
            --border-color: #e2e8f0;
            --input-border: #cbd5e1;
            --input-background: #fff;
            --shadow-color: rgba(0,0,0,0.05);
            --primary-color: #3b82f6;
            --primary-hover: #2563eb;
            --danger-color: #ef4444;
            --danger-hover: #dc2626;
            --section-bg: #f1f5f9;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --tab-active-border: #3b82f6;
            --info-color: #0ea5e9;
        }

        [data-theme="dark"] {
            --background-color: #0f172a;
            --card-background: #1e293b;
            --text-color: #cbd5e1;
            --heading-color: #f1f5f9;
            --secondary-text: #94a3b8;
            --border-color: #334155;
            --input-border: #475569;
            --input-background: #334155;
            --shadow-color: rgba(0,0,0,0.3);
            --primary-color: #60a5fa;
            --primary-hover: #93c5fd;
            --danger-color: #ef4444;
            --danger-hover: #f87171;
            --section-bg: #2d3748;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --tab-active-border: #60a5fa;
            --info-color: #38bdf8;
        }
        
        /* API Credentials Card Styles */
        .credentials-card {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.95), rgba(30, 41, 59, 0.8)) !important;
            border-left: 4px solid var(--primary-color) !important;
            transition: all 0.3s ease;
        }
        
        .credentials-card:hover {
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.25), 0 0 15px rgba(96, 165, 250, 0.15) !important;
            transform: translateY(-5px);
        }
        
        .credentials-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .credential-item {
            padding: 16px;
            background: rgba(15, 23, 42, 0.4);
            border-radius: 12px;
            border: 1px solid rgba(96, 165, 250, 0.1);
            transition: all 0.2s ease;
        }
        
        .credential-item:hover {
            background: rgba(15, 23, 42, 0.5);
            border-color: rgba(96, 165, 250, 0.3);
        }
        
        .credential-item label {
            display: block;
            margin-bottom: 8px;
            color: #94a3b8;
            font-size: 0.85rem;
            font-weight: 500;
            letter-spacing: 0.5px;
        }
        
        .input-with-copy {
            display: flex;
            align-items: center;
            position: relative;
        }
        
        .input-with-copy input {
            width: 100%;
            padding: 12px 42px 12px 16px;
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid rgba(96, 165, 250, 0.2);
            border-radius: 10px;
            color: #f1f5f9;
            font-family: 'Consolas', monospace;
            font-size: 0.95rem;
            letter-spacing: 0.5px;
        }
        
        .input-with-copy .copy-btn {
            position: absolute;
            right: 8px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(96, 165, 250, 0.1) !important;
            color: var(--primary-color) !important;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            box-shadow: none !important;
        }
        
        .input-with-copy .copy-btn:hover {
            background: rgba(96, 165, 250, 0.25) !important;
            color: #f1f5f9 !important;
            transform: translateY(0) !important;
        }
        
        .input-with-copy .copy-btn svg {
            width: 16px;
            height: 16px;
            stroke: currentColor;
        }
        
        .reset-key-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            background: linear-gradient(135deg, #ef4444 0%, #b91c1c 100%) !important;
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }
        
        .reset-key-btn:hover {
            background: linear-gradient(135deg, #b91c1c 0%, #ef4444 100%) !important;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(239, 68, 68, 0.4);
        }
        
        .credential-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 8px;
        }
        
        /* Status Badge */
        .status-badge {
            display: flex;
            align-items: center;
        }
        
        .status-badge .badge {
            padding: 8px 16px;
            border-radius: 30px;
            font-weight: 600;
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            letter-spacing: 0.5px;
        }
        
        /* Stats Card Styles */
        .stats-card {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.7), rgba(30, 41, 59, 0.5)) !important;
            border-left: 4px solid var(--success-color) !important;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 16px;
        }
        
        .stat-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: rgba(15, 23, 42, 0.4);
            border-radius: 12px;
            border: 1px solid rgba(96, 165, 250, 0.1);
            transition: all 0.3s ease;
        }
        
        .stat-item:hover {
            transform: translateY(-3px);
            background: rgba(15, 23, 42, 0.5);
            border-color: rgba(96, 165, 250, 0.2);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        
        .stat-icon {
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(96, 165, 250, 0.1);
            border-radius: 12px;
            flex-shrink: 0;
        }
        
        .stat-icon svg {
            width: 24px;
            height: 24px;
            stroke: var(--primary-color);
        }
        
        .stat-content {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .stat-label {
            font-size: 0.85rem;
            color: #94a3b8;
            font-weight: 500;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #f1f5f9;
        }
        
        /* App Info Card */
        .app-info-card {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.9), rgba(30, 41, 59, 0.7)) !important;
            border-left: 4px solid var(--info-color) !important;
        }

        /* Custom context menu styling */
        .custom-context-menu {
            display: none;
            position: absolute;
            width: 200px;
            background: var(--bg-card);
            box-shadow: var(--card-shadow);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 8px 0;
            z-index: 1000;
        }
        
        .custom-context-menu-item {
            padding: 8px 15px;
            cursor: pointer;
            font-size: 14px;
            color: var(--text-secondary);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .custom-context-menu-item:hover {
            background: var(--bg-card-hover);
            color: var(--text-primary);
        }
        
        .custom-context-menu-separator {
            height: 1px;
            background: var(--border-color);
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <!-- Animated background elements -->
    <div class="animated-bg">
        <div class="bg-element"></div>
        <div class="bg-element"></div>
        <div class="bg-element"></div>
    </div>

    <div id="custom-modal-overlay" class="custom-modal-overlay">
        <div class="custom-modal">
            <div class="modal-icon">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>
            </div>
            <div class="modal-title" id="custom-modal-title">Are you sure?</div>
            <div class="modal-message" id="custom-modal-message">Are you sure you want to proceed?</div>
            <div class="modal-actions">
                <button class="modal-btn cancel" onclick="closeCustomModal()">Cancel</button>
                <button class="modal-btn confirm" id="custom-modal-confirm-btn">Confirm</button>
            </div>
        </div>
    </div>

    <div id="custom-input-modal-overlay" class="custom-input-modal-overlay">
        <div class="custom-input-modal">
            <div class="modal-icon">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 17.25V21h3.75l11.06-11.06-3.75-3.75L3 17.25zm14.71-9.04a1.003 1.003 0 0 0 0-1.42l-2.5-2.5a1.003 1.003 0 0 0-1.42 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
            </div>
            <div class="modal-title" id="custom-input-modal-title">Edit Value</div>
            <div class="modal-message" id="custom-input-modal-message">Enter a new value:</div>
            <input class="modal-input" id="custom-input-modal-input" type="text" />
            <div class="modal-actions">
                <button class="modal-btn cancel" onclick="closeCustomInputModal()">Cancel</button>
                <button class="modal-btn confirm" id="custom-input-modal-confirm-btn">Save</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h2>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M4 8h4V4H4v4zm6 12h4v-4h-4v4zm-6 0h4v-4H4v4zm0-6h4v-4H4v4zm6 0h4v-4h-4v4zm6-10v4h4V4h-4zm-6 4h4V4h-4v4zm6 6h4v-4h-4v4zm0 6h4v-4h-4v4z"/>
                </svg>
                Manage <span class="app-name" id="app-name">Loading...</span>
            </h2>
            <div class="controls">
                <button class="back-btn" onclick="goBack()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M19 12H5"></path>
                        <path d="M12 19l-7-7 7-7"></path>
                    </svg>
                    Back to Dashboard
                </button>
                <div class="theme-switch">
                    <label class="switch">
                        <input type="checkbox" id="theme-toggle" onchange="toggleTheme()">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
        </div>

        <div class="tab-nav">
            <button class="tab-button active" onclick="openTab('overview')">Overview</button>
            <button class="tab-button" onclick="openTab('licenses')">Licenses</button>
            <button class="tab-button" onclick="openTab('user-details')">User Details</button>
            <button class="tab-button" onclick="openTab('settings')">Settings</button>
        </div>

        <!-- Overview Tab -->
        <div id="overview" class="tab-content active">
            <div class="card app-info-card">
                <h3>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/>
                    </svg>
                    Application Information
                </h3>
                
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label>Application Name</label>
                            <div class="input-with-copy">
                                <input type="text" id="app-name-overview" readonly>
                                <button type="button" class="copy-btn" onclick="copyToClipboard('app-name-overview')" title="Copy">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label>Status</label>
                            <div class="status-badge">
                                <span id="app-status-badge" class="badge badge-success">Active</span>
                                <input type="hidden" id="app-status-overview" value="active">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card credentials-card">
                <h3>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1s3.1 1.39 3.1 3.1v2z"/>
                    </svg>
                    API Credentials
                </h3>
                
                <div class="api-credentials-container">
                    <div class="credentials-group">
                        <div class="credential-item">
                            <label>Owner ID</label>
                            <div class="input-with-copy">
                                <input type="text" id="app-owner-id-overview" readonly>
                                <button type="button" class="copy-btn" onclick="copyToClipboard('app-owner-id-overview')" title="Copy">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        
                        <div class="credential-item">
                            <label>Application ID</label>
                            <div class="input-with-copy">
                                <input type="text" id="app-id-overview" readonly>
                                <button type="button" class="copy-btn" onclick="copyToClipboard('app-id-overview')" title="Copy">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        
                        <div class="credential-item">
                            <label>Secret Key</label>
                            <div class="input-with-copy">
                                <input type="text" id="app-secret-overview" readonly>
                                <button type="button" class="copy-btn" onclick="copyToClipboard('app-secret-overview')" title="Copy">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="credential-actions">
                        <button id="reset-secret-btn-overview" onclick="resetSecretKey()" class="reset-key-btn">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M23 4v6h-6"></path>
                                <path d="M1 20v-6h6"></path>
                                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10"></path>
                                <path d="M20.49 15a9 9 0 0 1-14.85 3.36L1 14"></path>
                            </svg>
                            Reset Secret Key
                        </button>
                    </div>
                </div>
            </div>

            <div class="card stats-card">
                <h3>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zM8 11c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3zm6.62 7.16c-1.02 0-1.85-.83-1.85-1.85s.83-1.85 1.85-1.85 1.85.83 1.85 1.85-.83 1.85-1.85 1.85zM15 11c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                    </svg>
                    Statistics
                </h3>
                
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M20 5H8.5a2.5 2.5 0 0 0 0 5h7a2.5 2.5 0 0 1 0 5H4"></path>
                                <line x1="16" y1="2" x2="16" y2="8"></line>
                                <line x1="8" y1="16" x2="8" y2="22"></line>
                            </svg>
                        </div>
                        <div class="stat-content">
                            <span class="stat-label">Total Licenses</span>
                            <span class="stat-value" id="total-licenses">0</span>
                        </div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                <line x1="16" y1="2" x2="16" y2="6"></line>
                                <line x1="8" y1="2" x2="8" y2="6"></line>
                                <line x1="3" y1="10" x2="21" y2="10"></line>
                            </svg>
                        </div>
                        <div class="stat-content">
                            <span class="stat-label">Created Date</span>
                            <span class="stat-value" id="created-date">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Licenses Tab -->
        <div id="licenses" class="tab-content">
            <div class="card">
                <h3>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm-2 16l-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z"/>
                    </svg>
                    Create License
                </h3>
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="license-duration-type">Duration Type</label>
                            <select id="license-duration-type" onchange="handleDurationTypeChange()">
                                <option value="days">Days</option>
                                <option value="months">Months</option>
                                <option value="years">Years</option>
                                <option value="specific-date" selected>Specific Date</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="license-duration-value">Duration Value</label>
                            <input type="number" id="license-duration-value" min="1" value="1">
                        </div>
                    </div>
                    <div class="form-col" id="expiry-date-container">
                        <div class="form-group">
                            <label for="license-expiry-date">Expiry Date (DD/MM/YYYY)</label>
                            <div style="position: relative;">
                                <input type="date" id="license-expiry-date" placeholder="DD/MM/YYYY" style="cursor: pointer; width: 100%; background-color: var(--input-background); color: var(--text-color); padding: 12px 16px; border-radius: 8px; border: 1px solid var(--input-border); appearance: none; -webkit-appearance: none;">
                                <svg xmlns="http://www.w3.org/2000/svg" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); pointer-events: none; width: 20px; height: 20px; fill: var(--primary-color);" viewBox="0 0 24 24">
                                    <path d="M20 3h-1V1h-2v2H7V1H5v2H4c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 18H4V8h16v13z"/>
                                    <path d="M9 10H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2zm-8 4H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2z"/>
                                </svg>
                            </div>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="license-name">License Name (Optional)</label>
                            <input type="text" id="license-name" placeholder="e.g. Client A License">
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="license-custom-key">Custom Key (Optional)</label>
                            <input type="text" id="license-custom-key" placeholder="Leave blank for auto-generated">
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="license-qty">Quantity</label>
                            <input type="number" id="license-qty" min="1" max="100" value="1">
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="disable-hwid">Disable Hardware ID</label>
                            <select id="disable-hwid">
                                <option value="false">No (Requires Device Activation)</option>
                                <option value="true">Yes (Works on All Devices)</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="form-actions">
                    <button id="create-license-btn" onclick="createLicense()">Generate License</button>
                </div>
            </div>

            <div class="card">
                <h3>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/>
                    </svg>
                    License Keys
                </h3>
                
                <div class="table-container">
                    <table id="licenses-table">
                        <thead>
                            <tr>
                                <th>License Key</th>
                                <th>Name</th>
                                <th>Duration</th>
                                <th>Created</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="licenses-body">
                            <!-- Will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
                
                <div id="licenses-empty" class="empty-state" style="display: none;">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/>
                    </svg>
                    <p>No licenses found</p>
                    <p>Create a license to get started</p>
                </div>
            </div>
        </div>
        
        <!-- User Details Tab -->
        <div id="user-details" class="tab-content">
            <div class="card">
                <h3>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm-2 16l-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z"/>
                    </svg>
                    License Details
                </h3>
                
                <div class="table-container" id="license-list-container">
                    <table id="user-licenses-table">
                        <thead>
                            <tr>
                                <th>License Key</th>
                                <th>Name</th>
                                <th>Duration</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="user-licenses-body">
                            <!-- Will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>

                <div id="no-licenses-found" class="empty-state" style="display: none;">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                    </svg>
                    <p>No licenses found for this application</p>
                    <p>Create a license in the Licenses tab</p>
                    </div>
                </div>
                
            <div id="license-details-container" class="card" style="display: none;">
                <h3>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                    </svg>
                    Selected License Information
                </h3>
                
                <div id="selected-license-details">
                    <!-- Will be populated when a license is selected -->
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settings" class="tab-content">
            <div class="card">
                <h3>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/>
                    </svg>
                    App Settings
                </h3>
                
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="app-name-setting">Application Name</label>
                            <input type="text" id="app-name-setting">
                        </div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="app-status">Application Status</label>
                            <select id="app-status">
                                <option value="active">Active</option>
                                <option value="disabled">Disabled</option>
                                <option value="suspended">Suspended</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button id="save-settings-btn" onclick="saveSettings()">Save Settings</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add this to the bottom of the body tag -->
    <div class="modal-overlay" id="confirmation-modal">
        <div class="confirmation-modal">
            <div class="confirmation-modal-header">
                <div class="confirmation-modal-icon danger">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22ZM12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20ZM12 7C12.5523 7 13 7.44772 13 8V12C13 12.5523 12.5523 13 12 13C11.4477 13 11 12.5523 11 12V8C11 7.44772 11.4477 7 12 7ZM12 14C12.5523 14 13 14.4477 13 15C13 15.5523 12.5523 16 12 16C11.4477 16 11 15.5523 11 15C11 14.4477 11.4477 14 12 14Z" />
                    </svg>
                </div>
                <div class="confirmation-modal-title">Confirm Action</div>
            </div>
            <div class="confirmation-modal-body" id="confirmation-modal-message">
                Are you sure you want to delete this license?
            </div>
            <div class="confirmation-modal-actions">
                <button class="cancel-btn" onclick="closeConfirmationModal()">Cancel</button>
                <button class="confirm-btn" id="confirm-action-btn">Delete</button>
            </div>
        </div>
    </div>

    <!-- Replace the existing toast div with this improved version -->
    <div id="toast" class="toast">
        <div class="toast-header">
            <div class="toast-icon">
                <!-- Icon will be added by JavaScript -->
            </div>
            <div class="toast-content">
                <div class="toast-title">Notification</div>
            </div>
            <div class="toast-close" onclick="hideToast()">Ã—</div>
        </div>
        <div class="toast-message" id="toast-message">This is a notification</div>
        <div class="toast-progress"></div>
    </div>

    <!-- Custom context menu -->
    <div class="custom-context-menu" id="customContextMenu">
        <div class="custom-context-menu-item" id="refresh">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
                <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
            </svg>
            Refresh
        </div>
        <div class="custom-context-menu-item" id="back">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"/>
            </svg>
            Back
        </div>
        <div class="custom-context-menu-item" id="forward">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M1 8a.5.5 0 0 1 .5-.5h11.793l-3.147-3.146a.5.5 0 0 1 .708-.708l4 4a.5.5 0 0 1 0 .708l-4 4a.5.5 0 0 1-.708-.708L13.293 8.5H1.5A.5.5 0 0 1 1 8z"/>
            </svg>
            Forward
        </div>
        <div class="custom-context-menu-separator"></div>
        <div class="custom-context-menu-item" id="print">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path d="M2.5 8a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1z"/>
                <path d="M5 1a2 2 0 0 0-2 2v2H2a2 2 0 0 0-2 2v3a2 2 0 0 0 2 2h1v1a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2v-1h1a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-1V3a2 2 0 0 0-2-2H5zM4 3a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1v2H4V3zm1 5a2 2 0 0 0-2 2v1H2a1 1 0 0 1-1-1V7a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v-1a2 2 0 0 0-2-2H5z"/>
            </svg>
            Print
        </div>
        <div class="custom-context-menu-item" id="save">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
            </svg>
            Save As
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Security measures to protect against source code viewing and tampering
        (function() {
            // Anti-debugging techniques
            const antiDebug = function() {
                // Check if devtools is open
                const threshold = 160;
                const widthThreshold = window.outerWidth - window.innerWidth > threshold;
                const heightThreshold = window.outerHeight - window.innerHeight > threshold;
                
                if (widthThreshold || heightThreshold || 
                    window.Firebug && window.Firebug.chrome && window.Firebug.chrome.isInitialized || 
                    window.console && window.console.firebug) {
                    
                    document.body.innerHTML = `<div style="display: flex; justify-content: center; align-items: center; height: 100vh; color: white; font-family: Arial; flex-direction: column; background-color: #1a1a2e;">
                        <h1>Access Denied</h1>
                        <p>Developer tools detected. Please close developer tools and refresh the page.</p>
                    </div>`;
                    
                    // Clear local storage to force re-login
                    setTimeout(() => {
                        localStorage.clear();
                    }, 2000);
                    
                    return true;
                }
                return false;
            };
            
            // Prevent right-click context menu
            document.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                return false;
            });
            
            // Prevent keyboard shortcuts for developer tools
            document.addEventListener('keydown', function(e) {
                // Prevent: F12, Ctrl+Shift+I, Ctrl+Shift+J, Ctrl+Shift+C
                if (
                    e.keyCode === 123 || 
                    (e.ctrlKey && e.shiftKey && (e.keyCode === 73 || e.keyCode === 74 || e.keyCode === 67))
                ) {
                    e.preventDefault();
                    return false;
                }
                
                // Prevent Ctrl+U (view source)
                if (e.ctrlKey && e.keyCode === 85) {
                    e.preventDefault();
                    return false;
                }
                
                // Prevent Ctrl+S (save page)
                if (e.ctrlKey && e.keyCode === 83) {
                    e.preventDefault();
                    return false;
                }
            });
            
            // Disable console functions
            const disableConsole = function() {
                try {
                    // Store original console methods
                    const originalConsole = {
                        log: console.log,
                        warn: console.warn,
                        error: console.error,
                        info: console.info,
                        debug: console.debug
                    };
                    
                    // Override console methods
                    console.log = console.warn = console.error = console.info = console.debug = function() {
                        // Do nothing or show fake messages
                        return undefined;
                    };
                    
                    // Only allow our debug to use the original console
                    window._debugLog = function(msg) {
                        originalConsole.log(msg);
                    };
                } catch (e) {}
            };
            
            // Implement code obfuscation in production
            if (window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
                // Simple string obfuscation for sensitive data
                window.obfuscate = function(str) {
                    return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, function(match, p1) {
                        return String.fromCharCode('0x' + p1);
                    }));
                };
                
                window.deobfuscate = function(str) {
                    return decodeURIComponent(atob(str).split('').map(function(c) {
                        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                    }).join(''));
                };
                
                // Override localStorage to encrypt/decrypt data
                const originalSetItem = localStorage.setItem;
                const originalGetItem = localStorage.getItem;
                
                localStorage.setItem = function(key, value) {
                    // Don't encrypt auth token to avoid breaking login
                    if (key !== 'authToken') {
                        value = window.obfuscate(value);
                    }
                    originalSetItem.call(localStorage, key, value);
                };
                
                localStorage.getItem = function(key) {
                    const value = originalGetItem.call(localStorage, key);
                    if (value && key !== 'authToken') {
                        try {
                            return window.deobfuscate(value);
                        } catch(e) {
                            return value;
                        }
                    }
                    return value;
                };
                
                // Disable console in production
                disableConsole();
            }
            
            // Initialize security checks after page load
        document.addEventListener('DOMContentLoaded', function() {
                if (antiDebug()) return;
                // Check periodically for devtools
                setInterval(antiDebug, 1000);
            });
        })();

        document.addEventListener('DOMContentLoaded', function() {
            // Get token from sessionStorage instead of localStorage
            let token = sessionStorage.getItem('authToken');
            
            // If no token, redirect to login
            if (!token) {
                console.error('No authentication token found');
                window.location.href = 'login.html';
                return;
            }
            
            // Check if we have the current app ID
            const appId = localStorage.getItem('currentAppId');
            const appName = localStorage.getItem('currentAppName');
            
            if (!appId) {
                console.error('No application ID found');
                window.location.href = 'dashboard.html';
                return;
            }
            
            console.log('Auth token available:', !!token);
            console.log('Current App ID:', appId);
            
            // Set the app name in the header
            document.getElementById('app-name').textContent = appName || 'Application';
            
            // Set dark theme as default
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
            
            // Set the toggle to match
            const themeToggle = document.getElementById('theme-toggle');
            if (themeToggle) {
                themeToggle.checked = savedTheme === 'dark';
            }
            
            // Set default expiry date (30 days from now)
            const defaultExpiry = new Date();
            defaultExpiry.setDate(defaultExpiry.getDate() + 30);
            // Format as YYYY-MM-DD for the date input
            const formattedDate = defaultExpiry.toISOString().split('T')[0];
            document.getElementById('license-expiry-date').value = formattedDate;
            
            // Hide duration value container since Specific Date is the default
            const durationValueContainer = document.getElementById('license-duration-value').parentNode.parentNode;
            durationValueContainer.style.display = 'none';
            
            // Initialize duration type handler
            handleDurationTypeChange();
            
            // First verify the token is valid
            const apiUrl = getApiBaseUrl();
            
            // Check the token validity
            fetch(`${apiUrl}/auth/me`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Token validation failed');
                }
                return response.json();
            })
            .then(data => {
                if (!data.success) {
                    console.error('Token validation failed:', data.message);
                    sessionStorage.removeItem('authToken');
                    window.location.href = 'login.html?error=invalid_token';
                    return;
                }
                
                // Token is valid, save the owner ID for future use
                if (data.data && (data.data.ownerId || data.data._id)) {
                    localStorage.setItem('currentOwnerId', data.data.ownerId || data.data._id);
                    console.log('Owner ID set:', data.data.ownerId || data.data._id);
                }
            
            // Load application details
            initializeApp(appId, appName);
            })
            .catch(error => {
                console.error('Auth verification error:', error);
                showToast(`Authentication error: ${error.message}. Please log in again.`, 'error');
                setTimeout(() => {
                    sessionStorage.removeItem('authToken');
                    window.location.href = 'login.html?error=auth_error';
                }, 2000);
            });
        });
        
        // Helper function to format duration display
        function formatDuration(days, durationType, durationValue) {
            if (durationType && durationValue) {
                // Use the stored duration type and value
                if (durationType === 'specific-date') {
                    try {
                        // Try to parse the date from durationValue
                        const date = new Date(durationValue);
                        if (!isNaN(date.getTime())) {
                            return `Until ${date.toLocaleDateString()}`;
                        }
                    } catch (e) {
                        console.error('Error parsing specific date:', e);
                    }
                }
                return `${durationValue} ${durationType}`;
            } else if (days > 365) {
                // Convert to years
                const years = Math.floor(days / 365);
                return `${years} year${years > 1 ? 's' : ''}`;
            } else if (days > 30) {
                // Convert to months
                const months = Math.floor(days / 30);
                return `${months} month${months > 1 ? 's' : ''}`;
            } else {
                // Display in days
                return `${days} day${days !== 1 ? 's' : ''}`;
            }
        }
        
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        }
        
        function goBack() {
            window.location.href = 'dashboard.html';
        }
        
        function openTab(tabName) {
            // Hide all tab contents
            var tabContents = document.getElementsByClassName('tab-content');
            for (var i = 0; i < tabContents.length; i++) {
                tabContents[i].classList.remove('active');
            }
            
            // Deactivate all tab buttons
            var tabButtons = document.getElementsByClassName('tab-button');
            for (var i = 0; i < tabButtons.length; i++) {
                tabButtons[i].classList.remove('active');
            }
            
            // Activate the selected tab and button
            document.getElementById(tabName).classList.add('active');
            document.querySelector(`[onclick="openTab('${tabName}')"]`).classList.add('active');
            
            // Load licenses when opening user details tab
            if (tabName === 'user-details') {
                loadLicensesForUserTab();
            }
        }
        
        function initializeApp(appId, appName) {
            // Update app name in the UI
            document.getElementById('app-name').textContent = appName;
            document.getElementById('app-name-overview').value = appName;
            document.getElementById('app-name-setting').value = appName;
            
            // Load application details
            const token = getAuthToken();
            const apiUrl = getApiBaseUrl();
            
            if (!token) {
                console.error('No auth token available');
                showToast('Authentication required. Please log in again.', 'error');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
                return;
            }
            
            fetch(`${apiUrl}/applications/${appId}`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    const app = data.data;
                    
                    // Debug logging to see all application data
                    console.log('Application data received:', app);
                    console.log('Owner ID from application:', app.ownerId);
                    
                    // Update fields
                    document.getElementById('app-id-overview').value = app.appId || 'N/A';
                    document.getElementById('app-secret-overview').value = app.appSecret || 'N/A';
                    document.getElementById('app-status-overview').value = app.status || 'active';
                    document.getElementById('app-status').value = app.status || 'active';
                    document.getElementById('app-owner-id-overview').value = app.ownerId || 'N/A';
                    
                    // Update status badge
                    const statusBadge = document.getElementById('app-status-badge');
                    if (statusBadge) {
                        statusBadge.textContent = app.status ? app.status.charAt(0).toUpperCase() + app.status.slice(1) : 'Active';
                        statusBadge.className = 'badge';
                        
                        // Add appropriate class based on status
                        if (app.status === 'active') {
                            statusBadge.classList.add('badge-success');
                        } else if (app.status === 'disabled' || app.status === 'suspended') {
                            statusBadge.classList.add('badge-warning');
                        } else {
                            statusBadge.classList.add('badge-info');
                        }
                    }
                    
                    // Set creation date
                    const createdDate = app.createdAt ? new Date(app.createdAt).toLocaleDateString() : 'N/A';
                    document.getElementById('created-date').textContent = createdDate;
                    
                    // Load licenses from database
                    loadLicenses(appId);
                } else {
                    console.error('Error loading application details:', data.message || 'Unknown error');
                    showToast(`Error loading application: ${data.message || 'Unknown error'}`, 'error');
                    // Still try to load licenses as fallback
                    loadLicensesFromStorage(appId);
                }
            })
            .catch(error => {
                console.error('Error loading application details:', error);
                showToast(`Error loading application: ${error.message}`, 'error');
                // Still try to load licenses as fallback
                loadLicensesFromStorage(appId);
            });
        }
        
        function loadLicenses(appId) {
            const token = getAuthToken();
            const ownerId = localStorage.getItem('currentOwnerId');
            console.log(`Loading licenses for app: ${appId}`);
            console.log('Owner ID available:', !!ownerId);
            
            if (!token) {
                console.error('No auth token available');
                showToast('Authentication required. Please log in again.', 'error');
                return;
            }
            
            if (!ownerId) {
                console.error('No owner ID available');
                showToast('Owner ID missing. Please refresh the page.', 'error');
                loadLicensesFromStorage(appId); // Fall back to local storage
                    return;
                }

            const apiUrl = getApiBaseUrl();
                
            // Add a timestamp to prevent caching
            const timestamp = new Date().getTime();
                
            // Fetch licenses from the database with both ownerId and appId
            const url = `${apiUrl}/licenses?ownerId=${ownerId}&appId=${appId}&_t=${timestamp}`;
            console.log(`Fetching licenses from: ${url}`);
                
            fetch(url, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Cache-Control': 'no-cache, no-store, must-revalidate',
                    'Pragma': 'no-cache',
                    'Expires': '0'
                }
            })
            .then(response => {
                console.log(`Server response status: ${response.status}`);
                if (!response.ok) {
                    throw new Error(`HTTP error ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log(`Server returned ${data.count || 0} licenses:`, data);
                    
                if (data.success) {
                    const licenses = data.data || [];
                    
                    // Filter licenses to ensure they belong to the current application
                    const filteredLicenses = licenses.filter(license => license.appId === appId);
                    console.log(`Filtered to ${filteredLicenses.length} licenses for this application`);
                    
                    // Store in localStorage for backup
                    localStorage.setItem(`licenses_${appId}`, JSON.stringify(filteredLicenses));
                    
                    // Update the UI
                    const licensesEmpty = document.getElementById('licenses-empty');
                    const licensesTable = document.getElementById('licenses-table');
                    
                    // Update stats in overview
                    document.getElementById('total-licenses').textContent = filteredLicenses.length;
                    
                    if (filteredLicenses && filteredLicenses.length > 0) {
                        // Show table and hide empty state
                        licensesEmpty.style.display = 'none';
                        licensesTable.style.display = 'table';
                        
                        // Populate the table
                        const licensesBody = document.getElementById('licenses-body');
                        licensesBody.innerHTML = ''; // Clear existing rows
                        
                        filteredLicenses.forEach(license => {
                            const row = document.createElement('tr');
                            const expiryDate = new Date(license.expiryDate);
                            const daysDifference = Math.ceil((expiryDate - new Date()) / (1000 * 60 * 60 * 24));
                            
                            // Format the duration display based on the stored duration type
                            let durationDisplay = formatDuration(daysDifference, license.durationType, license.durationValue);
                            
                            // Use _id if available, otherwise fall back to key for delete operations
                            const deleteId = license._id || license.key;
                            
                            row.innerHTML = `
                                <td class="license-key" data-id="${license._id || license.key}">
                                    <div style="display: flex; align-items: center;">
                                        <span>${license.key}</span>
                                        <button onclick="editLicenseKey('${license._id || license.key}', '${license.key}')" 
                                                style="margin-left: 5px; padding: 2px 5px; font-size: 10px; background: transparent; color: var(--primary-color); border: none;">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                            </svg>
                                        </button>
                                    </div>
                                </td>
                                <td class="license-name" data-id="${license._id || license.key}">
                                    <div style="display: flex; align-items: center;">
                                        <span>${license.name || 'Unnamed'}</span>
                                        <button onclick="renameLicense('${license._id || license.key}', '${license.name || ''}')" 
                                                style="margin-left: 5px; padding: 2px 5px; font-size: 10px; background: transparent; color: var(--primary-color); border: none;">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                            </svg>
                                        </button>
                                    </div>
                                </td>
                                <td>${durationDisplay}</td>
                                <td>${new Date(license.createdAt).toLocaleDateString()}</td>
                                <td><span class="badge badge-${license.status === 'active' ? 'success' : 'warning'}">${license.status}</span></td>
                                <td>
                                    <button onclick="deleteLicense('${deleteId}')" class="delete-btn" style="padding: 4px 8px; font-size: 12px;">Delete</button>
                                    ${license.hardwareId ? `<button onclick="revokeLicenseActivation('${deleteId}')" class="reset-btn" style="padding: 4px 8px; margin-left: 5px; font-size: 12px; background-color: #6c757d;">Reset Device</button>` : ''}
                                </td>
                            `;
                            licensesBody.appendChild(row);
                        });
                    } else {
                        // Show empty state
                        licensesEmpty.style.display = 'block';
                        licensesTable.style.display = 'none';
                    }
                } else {
                    console.error('Error loading licenses:', data.message);
                    // Fallback to localStorage
                    loadLicensesFromStorage(appId);
                }
            })
            .catch(error => {
                console.error('Error loading licenses:', error);
                showToast(`Error loading licenses: ${error.message}`, 'error');
                // Fallback to localStorage
                loadLicensesFromStorage(appId);
            });
        }
        
        function loadLicensesFromStorage(appId) {
            console.log('Loading licenses for app ID:', appId);
            // Check for existing licenses in localStorage
            const storedLicenses = JSON.parse(localStorage.getItem(`licenses_${appId}`)) || [];
            console.log('Retrieved licenses:', storedLicenses);
            
            const licensesEmpty = document.getElementById('licenses-empty');
            const licensesTable = document.getElementById('licenses-table');
            
            // Update stats in overview
            document.getElementById('total-licenses').textContent = storedLicenses.length;
            
            if (storedLicenses && storedLicenses.length > 0) {
                // Show table and hide empty state
                licensesEmpty.style.display = 'none';
                licensesTable.style.display = 'table';
                
                // Populate the table
                const licensesBody = document.getElementById('licenses-body');
                licensesBody.innerHTML = ''; // Clear existing rows
                
                storedLicenses.forEach(license => {
                    const row = document.createElement('tr');
                    let createdDate = 'N/A';
                    try {
                        createdDate = new Date(license.created).toLocaleDateString();
                    } catch (e) {
                        console.error('Error parsing date:', e);
                        createdDate = new Date().toLocaleDateString();
                    }
                    
                    // Format the duration display
                    let durationDisplay = formatDuration(license.duration, license.durationType, license.durationValue);
                    
                    // Use _id if available, otherwise fall back to key for delete operations
                    const deleteId = license._id || license.key;
                    
                    row.innerHTML = `
                        <td class="license-key" data-id="${license._id || license.key}">
                            <div style="display: flex; align-items: center;">
                                <span>${license.key}</span>
                                <button onclick="editLicenseKey('${license._id || license.key}', '${license.key}')" 
                                        style="margin-left: 5px; padding: 2px 5px; font-size: 10px; background: transparent; color: var(--primary-color); border: none;">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                    </svg>
                                </button>
                            </div>
                        </td>
                        <td class="license-name" data-id="${license._id || license.key}">
                            <div style="display: flex; align-items: center;">
                                <span>${license.name || 'Unnamed'}</span>
                                <button onclick="renameLicense('${license._id || license.key}', '${license.name || ''}')" 
                                        style="margin-left: 5px; padding: 2px 5px; font-size: 10px; background: transparent; color: var(--primary-color); border: none;">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                    </svg>
                                </button>
                            </div>
                        </td>
                        <td>${durationDisplay}</td>
                        <td>${createdDate}</td>
                        <td><span class="badge badge-success">Active</span></td>
                        <td>
                            <button onclick="deleteLicense('${deleteId}')" class="delete-btn" style="padding: 4px 8px; font-size: 12px;">Delete</button>
                            ${license.hardwareId ? `<button onclick="revokeLicenseActivation('${deleteId}')" class="reset-btn" style="padding: 4px 8px; margin-left: 5px; font-size: 12px; background-color: #6c757d;">Reset Device</button>` : ''}
                        </td>
                    `;
                    licensesBody.appendChild(row);
                });
            } else {
                // Show empty state
                licensesEmpty.style.display = 'block';
                licensesTable.style.display = 'none';
            }
        }
        
        function handleDurationTypeChange() {
            const durationType = document.getElementById('license-duration-type').value;
            const durationValueContainer = document.getElementById('license-duration-value').parentNode.parentNode;
            const expiryDateContainer = document.getElementById('expiry-date-container');
            
            if (durationType === 'specific-date') {
                durationValueContainer.style.display = 'none';
                expiryDateContainer.style.display = 'block';
            } else {
                durationValueContainer.style.display = 'block';
                expiryDateContainer.style.display = 'none';
            }
        }
        
        function createLicense() {
            const durationType = document.getElementById('license-duration-type').value;
            const quantity = document.getElementById('license-qty').value;
            const appId = localStorage.getItem('currentAppId');
            const appName = localStorage.getItem('currentAppName');
            const token = getAuthToken();
            const ownerId = localStorage.getItem('currentOwnerId');
            
            // Set default plan to 'basic' since we removed the dropdown
            const plan = 'basic';
            // Get the custom license name (if provided)
            const licenseName = document.getElementById('license-name').value || `License ${new Date().toLocaleDateString()}`;
            // Get custom key if provided
            const customKey = document.getElementById('license-custom-key').value || '';
            // Get hardware ID disable option
            const disableHwid = document.getElementById('disable-hwid').value === 'true';
            
            console.log('Creating license with type:', durationType);
            console.log('Token available:', !!token);
            console.log('Owner ID available:', !!ownerId);
            console.log('Hardware ID disabled:', disableHwid);
            console.log('Custom key:', customKey);
            
            if (!token) {
                showToast('Authentication token missing. Please login again.', 'error');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
                return;
            }

            if (!appId) {
                showToast('Application ID is missing.', 'error');
                return;
            }
            
            if (!ownerId) {
                showToast('Owner ID is missing. Please refresh the page.', 'error');
                return;
            }
            
            let durationValue, durationInDays, expiryDate;
            
            // Handle different duration types
            if (durationType === 'specific-date') {
                const dateInput = document.getElementById('license-expiry-date').value;
                console.log('Date input value:', dateInput);
                
                // Make sure we have a valid date input
                if (!dateInput) {
                    showToast('Please select a valid expiry date', 'error');
                    return;
                }
                
                const selectedDate = new Date(dateInput);
                console.log('Selected date:', selectedDate);
                
                // Check if date is valid
                if (isNaN(selectedDate.getTime())) {
                    showToast('Invalid date format. Please select a valid date.', 'error');
                    return;
                }
                
                const today = new Date();
                
                // Calculate days difference
                durationInDays = Math.ceil((selectedDate - today) / (1000 * 60 * 60 * 24));
                console.log('Duration in days:', durationInDays);
                
                if (durationInDays <= 0) {
                    showToast('Expiry date must be in the future!', 'error');
                    return;
                }
                
                // For API consistency, store the date string as the durationValue
                // Make sure we use a consistent format: YYYY-MM-DD
                durationValue = dateInput; // This is already in YYYY-MM-DD format from the input
                expiryDate = selectedDate;
            } else {
                // Regular duration handling
                durationValue = document.getElementById('license-duration-value').value;
                
                // Calculate duration in days based on selected type
                switch(durationType) {
                    case 'days':
                        durationInDays = parseInt(durationValue);
                        break;
                    case 'months':
                        durationInDays = parseInt(durationValue) * 30; // Approximate months as 30 days
                        break;
                    case 'years':
                        durationInDays = parseInt(durationValue) * 365; // Approximate years as 365 days
                        break;
                    default:
                        durationInDays = parseInt(durationValue);
                }
            }

            // Use the stored owner ID
            const apiUrl = getApiBaseUrl();
            console.log('API URL:', apiUrl);
            console.log('Owner ID:', ownerId);
            
            let requestData = {
                ownerId: ownerId,
                appId: appId,
                plan: plan || 'basic',
                duration: durationInDays,
                durationType: durationType,
                durationValue: durationValue,
                name: licenseName,
                disableHwid: disableHwid,  // Add the hardware ID disable option
                // Add uniqueWithinApp flag to ensure license name is unique within the app
                uniqueWithinApp: true
            };
            
            // Add custom key if provided
            if (customKey) {
                requestData.customKey = customKey;
            }
            
            console.log('Sending license creation request with:', requestData);
            
            let successCount = 0;
            let errors = [];
            
            // Create and save licenses one by one
            const createLicensePromises = [];
            
            for (let i = 0; i < quantity; i++) {
                // For multiple licenses with custom key, make each one unique by adding an index
                if (customKey && quantity > 1) {
                    requestData.customKey = `${customKey}-${i+1}`;
                }
                
                const createPromise = fetch(`${apiUrl}/licenses/create`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(requestData)
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        successCount++;
                        return data.data;
                    } else {
                        errors.push(data.message || 'Unknown error');
                        return null;
                    }
                })
                .catch(error => {
                    errors.push(error.message || 'Network error');
                    return null;
                });
                
                createLicensePromises.push(createPromise);
            }
            
            // Wait for all licenses to be created
            Promise.all(createLicensePromises)
            .then(results => {
                // Filter out null results (failed creations)
                const licenses = results.filter(lic => lic !== null);
                
                if (successCount > 0) {
                    showToast(`${successCount} license(s) created successfully!`, 'success');
                    
                    // Also store in localStorage for UI display
                    const storedLicenses = JSON.parse(localStorage.getItem(`licenses_${appId}`)) || [];
                    const newLicenses = [...storedLicenses, ...licenses];
                    localStorage.setItem(`licenses_${appId}`, JSON.stringify(newLicenses));
                    
                    // Update the UI
                    document.getElementById('total-licenses').textContent = newLicenses.length;
                    loadLicenses(appId); // Try to load from server first
                    
                    // Clear the form fields
                    document.getElementById('license-custom-key').value = '';
                    document.getElementById('license-name').value = '';
                    document.getElementById('license-qty').value = '1';
                    
                    // Update metadata
                    updateLicenseMetadata(appId, newLicenses.length);
                }
                
                if (errors.length > 0) {
                    // Format the error message to be more readable
                    const errorMessage = errors.length === 1 
                        ? `Error creating license: ${errors[0]}`
                        : `Errors creating some licenses:\n- ${errors.join('\n- ')}`;
                    
                    console.error(errorMessage);
                    showToast(errorMessage, 'error');
                }
            });
        }
        
        function deleteLicense(licenseId) {
            showCustomModal({
                title: 'Delete License',
                message: 'Are you sure you want to delete this license? This action cannot be undone.',
                onConfirm: function() {
                    const appId = localStorage.getItem('currentAppId');
                    const token = getAuthToken();
                    const apiUrl = getApiBaseUrl();
                    
                    // Debug: Log token, appId, licenseId
                    console.log('[DEBUG] deleteLicense called:', { token, appId, licenseId });
                    
                    // Update localStorage first for immediate UI feedback
                    const storedLicenses = JSON.parse(localStorage.getItem(`licenses_${appId}`)) || [];
                    const updatedLicenses = storedLicenses.filter(license => 
                        license._id !== licenseId && license.key !== licenseId
                    );
                    localStorage.setItem(`licenses_${appId}`, JSON.stringify(updatedLicenses));
                    document.getElementById('total-licenses').textContent = updatedLicenses.length;
                    loadLicensesFromStorage(appId);
                    showToast('License has been deleted successfully', 'success');
                    
                    // Then delete from the database
                    const deleteUrl = `${apiUrl}/licenses/${licenseId}?appId=${appId}`;
                    fetch(deleteUrl, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('[DEBUG] deleteLicense API response:', data);
                        if (data.success) {
                            setTimeout(() => {
                                loadLicenses(appId);
                                updateLicenseMetadata(appId, updatedLicenses.length);
                            }, 1000);
                        } else {
                            showToast(`License may not have been deleted from database: ${data.message || 'Unknown error'}`, "warning");
                        }
                    })
                    .catch(error => {
                        console.error('[DEBUG] deleteLicense API error:', error);
                        showToast('Could not delete license from database: ' + error.message, "error");
                        setTimeout(() => loadLicenses(appId), 1000);
                    });
                }
            });
        }
        
        function saveSettings() {
            const appId = localStorage.getItem('currentAppId');
            const token = getAuthToken();
            const name = document.getElementById('app-name-setting').value;
            const status = document.getElementById('app-status').value;
            const apiUrl = getApiBaseUrl();
            
            fetch(`${apiUrl}/applications/${appId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    name,
                    status
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    showToast('Settings saved successfully!', 'success');
                    // Update app name in header and localStorage
                    document.getElementById('app-name').textContent = name;
                    document.getElementById('app-name-overview').value = name;
                    localStorage.setItem('currentAppName', name);
                } else {
                    showToast(`Could not save settings: ${data.message || 'Unknown error'}`, 'error');
                }
            })
            .catch(error => {
                showToast(`Error: ${error.message}`, 'error');
            });
        }
        
        function resetSecretKey() {
            showCustomModal({
                title: 'Reset Secret Key',
                message: 'Are you sure you want to reset the secret key? This will invalidate all existing integrations.',
                onConfirm: function() {
                    const appId = localStorage.getItem('currentAppId');
                    const token = getAuthToken();
                    const apiUrl = getApiBaseUrl();
                    
                    fetch(`${apiUrl}/applications/${appId}/reset-secret`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            document.getElementById('app-secret-overview').value = data.data.appSecret;
                            showToast('Secret key has been reset successfully', 'success');
                        } else {
                            showToast(`Error: ${data.message || 'Failed to reset secret key'}`, 'error');
                        }
                    })
                    .catch(error => {
                        showToast(`Error: ${error.message}`, 'error');
                    });
                }
            });
        }
        
        // Add metadata update functions
        function updateLicenseMetadata(appId, licenseCount) {
            const token = getAuthToken();
            
            // Get the current app data first
            fetch(`http://localhost:5001/api/applications/${appId}`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const app = data.data;
                    
                    // Update the app metadata
                    const updatedApp = {
                        ...app,
                        licenseCount: licenseCount,
                        lastUpdated: new Date().toISOString()
                    };
                    
                    // Save the updated app back to the server
                    fetch(`http://localhost:5001/api/applications/${appId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(updatedApp)
                    })
                    .then(response => response.json())
                    .then(updateData => {
                        console.log('Updated application with license metadata:', updateData);
                    })
                    .catch(error => {
                        console.error('Error updating application with license metadata:', error);
                    });
                }
            })
            .catch(error => {
                console.error('Error getting application data:', error);
            });
        }
        
        function updateLicense(licenseId, field, currentValue) {
            const fieldName = field === 'name' ? 'name' : 'key';
            const promptMessage = `Enter a new ${fieldName} for this license:`;
            showCustomInputModal({
                title: `Edit ${fieldName.charAt(0).toUpperCase() + fieldName.slice(1)}`,
                message: promptMessage,
                value: currentValue || '',
                onConfirm: function(newValue) {
                    if (fieldName === 'key' && !newValue.trim()) {
                        showToast("License key cannot be empty", "error");
                        return;
                    }
                    const token = getAuthToken();
                    const appId = localStorage.getItem('currentAppId');
                    const apiUrl = getApiBaseUrl();
                    
                    const requestBody = {};
                    requestBody[fieldName] = fieldName === 'key' ? newValue.trim() : (newValue || '');
                    
                    fetch(`${apiUrl}/licenses/rename/${licenseId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(requestBody)
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            const cells = document.querySelectorAll(`.license-${fieldName}[data-id="${licenseId}"]`);
                            cells.forEach(cell => {
                                const valueSpan = cell.querySelector('span');
                                if (valueSpan) {
                                    valueSpan.textContent = fieldName === 'name' && !newValue ? 'Unnamed' : newValue;
                                }
                            });
                            
                            showToast(`License ${fieldName} updated successfully`, "success");
                            
                            // Also update in localStorage
                            const storedLicenses = JSON.parse(localStorage.getItem(`licenses_${appId}`)) || [];
                            const updatedLicenses = storedLicenses.map(license => {
                                if ((license._id && license._id === licenseId) || license.key === licenseId) {
                                    const updatedLicense = { ...license };
                                    updatedLicense[fieldName] = newValue;
                                    return updatedLicense;
                                }
                                return license;
                            });
                            localStorage.setItem(`licenses_${appId}`, JSON.stringify(updatedLicenses));
                        } else {
                            showToast(`Error updating license ${fieldName}: ${data.message || 'Unknown error'}`, "error");
                        }
                    })
                    .catch(error => {
                        showToast(`Error: ${error.message}`, "error");
                    });
                }
            });
        }
        
        // Use updateLicense for both name and key changes
        function renameLicense(licenseId, currentName) {
            updateLicense(licenseId, 'name', currentName);
        }
        
        function editLicenseKey(licenseId, currentKey) {
            updateLicense(licenseId, 'key', currentKey);
        }

        // Modified showToast function with debug logging
        function showToast(message, type = 'success') {
            console.log('Showing toast:', message, type);
            
            const toast = document.getElementById('toast');
            if (!toast) {
                console.error('Toast element not found!');
                return;
            }
            
            const toastMessage = document.getElementById('toast-message');
            if (!toastMessage) {
                console.error('Toast message element not found!');
                return;
            }
            
            // Set message
            toastMessage.textContent = message;
            
            // Set icon
            const iconContainer = toast.querySelector('.toast-icon');
            if (iconContainer) {
                iconContainer.innerHTML = getToastIcon(type);
            }
            
            // Set title
            const titleContainer = toast.querySelector('.toast-title');
            if (titleContainer) {
                titleContainer.textContent = getToastTitle(type);
            }
            
            // Set class
            toast.className = `toast ${type}`;
            
            // Show toast
            toast.classList.add('show');
            console.log('Toast class after adding show:', toast.className);
            
            // Hide after 3 seconds
            setTimeout(() => {
                hideToast();
            }, 3000);
        }

        // Initialize toast on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Test notification on page load to verify it's working
            setTimeout(() => {
                showToast('Welcome to the App Management Dashboard', 'info');
            }, 1000);
        });

        function hideToast() {
            const toast = document.getElementById('toast');
            toast.classList.remove('show');
        }

        function getToastIcon(type) {
            switch(type) {
                case 'success':
                    return '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22ZM12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20ZM11.0026 16L6.75999 11.7574L8.17421 10.3431L11.0026 13.1716L16.6595 7.51472L18.0737 8.92893L11.0026 16Z"></path></svg>';
                case 'error':
                    return '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22ZM12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20ZM12 13C11.4477 13 11 12.5523 11 12V8C11 7.44772 11.4477 7 12 7C12.5523 7 13 7.44772 13 8V12C13 12.5523 12.5523 13 12 13ZM12 16C12.5523 16 13 16.4477 13 17C13 17.5523 12.5523 18 12 18C11.4477 18 11 17.5523 11 17C11 16.4477 11.4477 16 12 16Z"></path></svg>';
                case 'warning':
                    return '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12.866 3L21.866 18C22.4797 19.0553 22.1613 20.417 21.1237 21.0568C20.7526 21.3168 20.3095 21.4553 19.8565 21.4553H3.85648C2.64704 21.4553 1.66648 20.4747 1.66648 19.2653C1.66648 18.8087 1.80611 18.3622 2.06815 17.9886L11.0682 2.98863C11.7072 1.93292 13.0681 1.61441 14.1238 2.25336C14.4939 2.50981 14.7885 2.86009 14.9682 3.26995L12.866 3Z"></path></svg>';
                default:
                    return '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22ZM12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20ZM11 7H13V9H11V7ZM11 11H13V17H11V11Z"></path></svg>';
            }
        }

        function getToastTitle(type) {
            switch(type) {
                case 'success':
                    return 'Success';
                case 'error':
                    return 'Error';
                case 'warning':
                    return 'Warning';
                default:
                    return 'Information';
            }
        }

        // Confirmation modal functions
        function showConfirmationModal(message, confirmCallback) {
            const modal = document.getElementById('confirmation-modal');
            const modalMessage = document.getElementById('confirmation-modal-message');
            const confirmButton = document.getElementById('confirm-action-btn');
            
            modalMessage.textContent = message;
            
            // Set the confirm action
            confirmButton.onclick = function() {
                confirmCallback();
                closeConfirmationModal();
            };
            
            // Show the modal
            modal.classList.add('active');
            
            // Prevent background scrolling
            document.body.style.overflow = 'hidden';
        }

        function closeConfirmationModal() {
            const modal = document.getElementById('confirmation-modal');
            modal.classList.remove('active');
            
            // Re-enable scrolling
            document.body.style.overflow = '';
        }

        // Custom Input Modal Logic
        function showCustomInputModal({title, message, value, onConfirm}) {
            document.getElementById('custom-input-modal-title').textContent = title || 'Edit Value';
            document.getElementById('custom-input-modal-message').textContent = message || 'Enter a new value:';
            const input = document.getElementById('custom-input-modal-input');
            input.value = value || '';
            document.getElementById('custom-input-modal-overlay').classList.add('active');
            input.focus();
            input.select();
            // Remove previous listeners
            const confirmBtn = document.getElementById('custom-input-modal-confirm-btn');
            const newBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newBtn, confirmBtn);
            newBtn.onclick = function() {
                closeCustomInputModal();
                if (typeof onConfirm === 'function') onConfirm(input.value);
            };
            input.onkeydown = function(e) {
                if (e.key === 'Enter') {
                    newBtn.click();
                }
            };
        }
        function closeCustomInputModal() {
            document.getElementById('custom-input-modal-overlay').classList.remove('active');
        }

        // Replace any confirm() or showConfirmationModal for deleteApplication with showCustomModal
        function deleteApplication(appId) {
            showCustomModal({
                title: 'Delete Application',
                message: 'Are you sure you want to delete this application? This action cannot be undone.',
                onConfirm: function() {
                    const token = getAuthToken();
                    // Debug: Log token, appId
                    console.log('[DEBUG] deleteApplication called:', { token, appId });
                    fetch(`http://localhost:5001/api/applications/${appId}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log('[DEBUG] deleteApplication API response:', data);
                        if (data.success) {
                            showToast('Application deleted successfully!', 'success');
                            window.location.href = 'dashboard.html';
                        } else {
                            showToast(`Error: ${data.message}`, 'error');
                        }
                    })
                    .catch(error => {
                        showToast(`Error: ${error.message}`, 'error');
                    });
                }
            });
        }

        // Custom Modal Logic (add if missing)
        function showCustomModal({title, message, onConfirm}) {
            // If modal HTML doesn't exist, do nothing
            var modal = document.getElementById('custom-modal-overlay');
            if (!modal) return;
            document.getElementById('custom-modal-title').textContent = title || 'Are you sure?';
            document.getElementById('custom-modal-message').textContent = message || 'Are you sure you want to proceed?';
            modal.classList.add('active');
            const confirmBtn = document.getElementById('custom-modal-confirm-btn');
            // Remove previous listeners
            const newBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newBtn, confirmBtn);
            newBtn.onclick = function() {
                closeCustomModal();
                if (typeof onConfirm === 'function') onConfirm();
            };
        }
        function closeCustomModal() {
            var modal = document.getElementById('custom-modal-overlay');
            if (modal) modal.classList.remove('active');
        }

        // Helper to get token from sessionStorage
        function getAuthToken() {
            return sessionStorage.getItem('authToken');
        }

        // Search user by license key
        function searchUserByLicense() {
            const licenseKey = document.getElementById('license-key-search').value.trim();
            const currentAppId = localStorage.getItem('currentAppId');
            
            if (!licenseKey) {
                showToast('Please enter a license key', 'error');
                return;
            }
            
            // Show loading state
            document.getElementById('user-license-details').style.display = 'none';
            document.getElementById('no-license-found').style.display = 'none';
            
            // Fetch license details with user information
            const token = getAuthToken();
            const apiUrl = getApiBaseUrl();
            
            fetch(`${apiUrl}/licenses/find-by-key`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ 
                    licenseKey,
                    appId: currentAppId // Add appId to request to scope search to current application
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.data) {
                    // Verify the license belongs to the current application
                    if (data.data.appId === currentAppId) {
                        renderUserDetails(data.data);
                        document.getElementById('user-license-details').style.display = 'block';
                    } else {
                        // License exists but belongs to a different application
                        document.getElementById('no-license-found').style.display = 'block';
                        showToast('License not found in this application', 'error');
                    }
                } else {
                    // API FAILED - Try local storage fallback
                    console.log('API search failed, trying local storage fallback');
                    searchLocalLicenseByKey(licenseKey, currentAppId);
                }
            })
            .catch(error => {
                console.error('Error fetching license details from API:', error);
                // Try local storage fallback
                console.log('API search failed with error, trying local storage fallback');
                searchLocalLicenseByKey(licenseKey, currentAppId);
            });
        }

        // Local storage fallback search by key
        function searchLocalLicenseByKey(licenseKey, appId) {
            try {
                // Get licenses from local storage
                const storedLicenses = JSON.parse(localStorage.getItem(`licenses_${appId}`)) || [];
                console.log('Searching locally for license key:', licenseKey);
                console.log('Total local licenses:', storedLicenses.length);
                
                // Find license by key
                const license = storedLicenses.find(license => license.key === licenseKey);
                
                if (license) {
                    console.log('Found license locally:', license);
                    renderUserDetails(license);
                    document.getElementById('user-license-details').style.display = 'block';
                    showToast('License found in local storage', 'info');
                } else {
                    document.getElementById('no-license-found').style.display = 'block';
                    showToast('License not found in this application', 'error');
                }
            } catch (error) {
                console.error('Error in local license search:', error);
                document.getElementById('no-license-found').style.display = 'block';
                showToast('Error searching for license', 'error');
            }
        }

        // Search user by license name
        function searchUserByLicenseName() {
            const licenseName = document.getElementById('license-name-search').value.trim();
            const currentAppId = localStorage.getItem('currentAppId');
            
            if (!licenseName) {
                showToast('Please enter a license name', 'error');
                return;
            }
            
            // Show loading state
            document.getElementById('user-license-details').style.display = 'none';
            document.getElementById('no-license-found').style.display = 'none';
            
            // First try local storage directly for faster response
            const storedLicenses = JSON.parse(localStorage.getItem(`licenses_${currentAppId}`)) || [];
            const searchTermLower = licenseName.toLowerCase().trim();
            
            // Try to find a match in local storage
            let license = storedLicenses.find(license => 
                license.name && (
                    license.name.toLowerCase() === searchTermLower ||
                    license.name.toLowerCase().includes(searchTermLower)
                )
            );
            
            if (license) {
                renderUserDetails(license);
                document.getElementById('user-license-details').style.display = 'block';
                document.getElementById('no-license-found').style.display = 'none';
                showToast('License found', 'success');
                return;
            }
            
            // If not found locally, try API
            const token = getAuthToken();
            const apiUrl = getApiBaseUrl();
            
            fetch(`${apiUrl}/licenses/find-by-name`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ 
                    licenseName,
                    appId: currentAppId // Add appId to request to scope search to current application
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.data) {
                    // Verify the license belongs to the current application
                    if (data.data.appId === currentAppId) {
                        renderUserDetails(data.data);
                        document.getElementById('user-license-details').style.display = 'block';
                        document.getElementById('no-license-found').style.display = 'none';
                    } else {
                        // License exists but belongs to a different application
                        searchLocalLicenseByName(licenseName, currentAppId);
                    }
                } else {
                    // API FAILED - Try more advanced local storage search
                    searchLocalLicenseByName(licenseName, currentAppId);
                }
            })
            .catch(error => {
                console.error('Error fetching license details by name:', error);
                // Try more advanced local storage search
                searchLocalLicenseByName(licenseName, currentAppId);
            });
        }

        // Local storage fallback search by name
        function searchLocalLicenseByName(licenseName, appId) {
            try {
                // Get licenses from local storage
                const storedLicenses = JSON.parse(localStorage.getItem(`licenses_${appId}`)) || [];
                console.log('Searching locally for license name:', licenseName);
                console.log('Total local licenses:', storedLicenses.length);
                
                // Find license by name with more flexible matching
                const searchTermLower = licenseName.toLowerCase().trim();
                
                // First try exact match
                let license = storedLicenses.find(license => 
                    license.name && license.name.toLowerCase() === searchTermLower
                );
                
                // If no exact match, try contains match
                if (!license) {
                    license = storedLicenses.find(license => 
                        license.name && license.name.toLowerCase().includes(searchTermLower)
                    );
                }
                
                // If still no match, try matching any word in the name
                if (!license) {
                    license = storedLicenses.find(license => 
                        license.name && searchTermLower.split(' ').some(word => 
                            license.name.toLowerCase().includes(word) && word.length > 2
                        )
                    );
                }
                
                if (license) {
                    console.log('Found license locally:', license);
                    renderUserDetails(license);
                    document.getElementById('user-license-details').style.display = 'block';
                    document.getElementById('no-license-found').style.display = 'none';
                    showToast('License found in local storage', 'success');
                } else {
                    // If all else fails, don't show any license as fallback
                    document.getElementById('no-license-found').style.display = 'block';
                    document.getElementById('user-license-details').style.display = 'none';
                    showToast('License not found in this application', 'error');
                }
            } catch (error) {
                console.error('Error in local license search:', error);
                document.getElementById('no-license-found').style.display = 'block';
                document.getElementById('user-license-details').style.display = 'none';
                showToast('Error searching for license', 'error');
            }
        }

        // Modified renderUserDetails to handle incomplete data
        function renderUserDetails(license) {
            const container = document.getElementById('user-license-details');
            
            // Calculate expiry date - handle missing data
            let expiryDate;
            try {
                expiryDate = license.expiryDate ? new Date(license.expiryDate) : null;
                if (!expiryDate || isNaN(expiryDate.getTime())) {
                    // If no valid expiry date, calculate it from creation date and duration
                    const createdDate = license.createdAt ? new Date(license.createdAt) : new Date();
                    const duration = license.duration || 30; // Default to 30 days if missing
                    expiryDate = new Date(createdDate);
                    expiryDate.setDate(expiryDate.getDate() + duration);
                }
            } catch (e) {
                console.error('Error calculating expiry date:', e);
                expiryDate = new Date();
                expiryDate.setDate(expiryDate.getDate() + 30); // Default to 30 days from now
            }
            
            const now = new Date();
            const isExpired = expiryDate < now;
            
            // Determine status based on license status field first, then fallback to expiration check
            // Make sure that newly created licenses show as 'Inactive' by default
            let status = license.status || 'inactive';
            if (isExpired && status === 'active') {
                status = 'expired';
            }
            
            // Map status to display text and CSS class
            let statusText, statusClass;
            switch(status) {
                case 'active':
                    statusText = 'Active';
                    statusClass = 'badge-active';
                    break;
                case 'expired':
                    statusText = 'Expired';
                    statusClass = 'badge-expired';
                    break;
                case 'inactive':
                default:
                    statusText = 'Inactive';
                    statusClass = 'badge-expired';
            }
            
            // Get hardware ID - always display it if available, regardless of binding state
            let hardwareId = license.hardwareId || 'Not yet activated';
            
            // Check if hardware ID is disabled
            const isHwidDisabled = license.disableHwid === true;
            
            container.innerHTML = `
                <div class="user-license-card">
                    <div class="user-license-header">
                        <h4>License Information</h4>
                        <span class="${statusClass}">${statusText}</span>
                    </div>
                    
                    <div class="user-detail-row">
                        <div class="user-detail-label">License Key</div>
                        <div class="user-detail-value"><code>${license.key || 'N/A'}</code></div>
                    </div>
                    
                    <div class="user-detail-row">
                        <div class="user-detail-label">License Name</div>
                        <div class="user-detail-value">${license.name || 'Unnamed License'}</div>
                    </div>
                    
                    <div class="user-detail-row">
                        <div class="user-detail-label">Plan</div>
                        <div class="user-detail-value">${license.plan || 'basic'}</div>
                    </div>
                    
                    <div class="user-detail-row">
                        <div class="user-detail-label">Created Date</div>
                        <div class="user-detail-value">${new Date(license.createdAt || new Date()).toLocaleString()}</div>
                    </div>
                    
                    <div class="user-detail-row">
                        <div class="user-detail-label">Expiry Date</div>
                        <div class="user-detail-value">${expiryDate.toLocaleString()}</div>
                    </div>
                    
                    <div class="user-detail-row">
                        <div class="user-detail-label">Hardware ID Binding</div>
                        <div class="user-detail-value">
                            ${isHwidDisabled 
                                ? '<span class="badge-success">Disabled (Works on All Devices)</span>' 
                                : '<span class="badge-warning">Enabled (Device-Specific)</span>'}
                        </div>
                    </div>
                    
                    ${license.hardwareId && status === 'active' ? `
                        <div class="user-detail-row">
                        <div class="user-detail-label">Hardware ID</div>
                        <div class="user-detail-value hw-id-container">
                            <span class="hw-id-hidden" style="cursor: pointer;" onclick="toggleHardwareIdDisplay(this)">
                                <i class="bi bi-eye"></i> Click to show Hardware ID
                            </span>
                            <span class="hw-id-value" style="display: none;">${hardwareId}</span>
                        </div>
                    </div>
                    ` : `
                    <div class="user-detail-row">
                        <div class="user-detail-label">Hardware ID</div>
                        <div class="user-detail-value">${hardwareId}</div>
                    </div>
                    `}
                    
                    ${license.activationDate ? `
                        <div class="user-detail-row">
                            <div class="user-detail-label">Activation Date</div>
                            <div class="user-detail-value">${new Date(license.activationDate).toLocaleString()}</div>
                        </div>
                    ` : ''}
                    
                    <div class="user-actions">
                        ${license.hardwareId ? `
                            <button class="reset-hwid-btn" onclick="resetHardwareId('${license._id || license.key}')">
                                <i class="bi bi-arrow-repeat"></i> Reset Hardware ID
                            </button>
                        ` : ''}
                        
                        <button class="toggle-hwid-btn" onclick="toggleHardwareIdBinding('${license._id || license.key}', ${isHwidDisabled})">
                            ${isHwidDisabled 
                                ? '<i class="bi bi-lock"></i> Enable Hardware ID Binding' 
                                : '<i class="bi bi-unlock"></i> Disable Hardware ID Binding'}
                        </button>
                    </div>
                </div>
            `;
        }
        
        // Reset hardware ID for a license
        function resetHardwareId(licenseId) {
            if (!confirm('Are you sure you want to reset the hardware ID for this license? The user will need to reactivate their license.')) {
                return;
            }
            
            fetch(`/api/licenses/${licenseId}/reset-hwid`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Hardware ID has been reset successfully', 'success');
                    // Refresh the user details
                    searchUserByLicense();
                } else {
                    showNotification('Failed to reset Hardware ID: ' + data.message, 'error');
                }
            })
            .catch(error => {
                console.error('Error resetting hardware ID:', error);
                showNotification('Error resetting Hardware ID', 'error');
            });
        }
        
        // Show notification
        function showNotification(message, type = 'info') {
            // Implement notification display logic
            alert(message);
        }

        // Helper function to get API base URL
        function getApiBaseUrl() {
            // First try getting from the current domain
            const host = window.location.hostname;
            const port = window.location.port;
            
            // If we're on localhost or 127.0.0.1, use port 5001
            if (host === 'localhost' || host === '127.0.0.1') {
                return 'http://localhost:5001/api';
            }
            
            // Otherwise use the current origin
            return window.location.origin + '/api';
        }

        // Add function to revoke license activation (reset hardware ID)
        function revokeLicenseActivation(licenseId) {
            showCustomModal({
                title: 'Reset License Device',
                message: 'Are you sure you want to reset this license? This will remove the device association and allow the license to be used on another device.',
                onConfirm: function() {
                    const token = getAuthToken();
                    const apiUrl = getApiBaseUrl();
                    
                    // Call the revoke endpoint
                    fetch(`${apiUrl}/licenses/${licenseId}/revoke`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            showToast('License device reset successfully', 'success');
                            // Reload the licenses to reflect the change
                            const appId = localStorage.getItem('currentAppId');
                            loadLicenses(appId);
                        } else {
                            showToast(`Error: ${data.message || 'Failed to reset license device'}`, 'error');
                        }
                    })
                    .catch(error => {
                        showToast(`Error: ${error.message}`, 'error');
                    });
                }
            });
        }

        // Function to toggle hardware ID binding for a license
        function toggleHardwareIdBinding(licenseId, currentState) {
            const newState = !currentState;
            const actionText = newState ? 'disable' : 'enable';
            
            showCustomModal({
                title: `${newState ? 'Disable' : 'Enable'} Hardware ID Binding`,
                message: `Are you sure you want to ${actionText} hardware ID binding for this license?\n\n${newState ? 'âœ… This license will work on all devices without requiring activation.' : 'âš ï¸ This license will require device-specific activation and will only work on one device at a time.'}`,
                onConfirm: function() {
                    const token = getAuthToken();
                    const apiUrl = getApiBaseUrl();
                    const appId = localStorage.getItem('currentAppId');
                    
                    // Log debugging information
                    console.log('Toggle HWID - Starting request with:', {
                        licenseId, 
                        newState, 
                        token: token ? 'Token exists' : 'No token', 
                        apiUrl
                    });
                    
                    // First update the license in local storage
                    const storedLicenses = JSON.parse(localStorage.getItem(`licenses_${appId}`)) || [];
                    let licenseUpdatedLocally = false;
                    let updatedLicense = null;
                    
                    // Find and update the license in local storage
                    const updatedLicenses = storedLicenses.map(license => {
                        if ((license._id && license._id === licenseId) || license.key === licenseId) {
                            licenseUpdatedLocally = true;
                            updatedLicense = {
                                ...license,
                                disableHwid: newState
                            };
                            return updatedLicense;
                        }
                        return license;
                    });
                    
                    if (licenseUpdatedLocally) {
                        localStorage.setItem(`licenses_${appId}`, JSON.stringify(updatedLicenses));
                        console.log('License updated locally', updatedLicense);
                    
                        // Update UI from local storage immediately to improve responsiveness
                        if (updatedLicense) {
                            displayLicenseDetails(updatedLicense);
                    }
                    
                    // Also update the licenses list
                        loadLicensesForUserTab();
                    }
                    
                    // Show processing message
                    showToast(`Processing request...`, 'info');
                    
                    // Now try to update on server using the direct license update endpoint
                    // with complete license data to ensure it works
                    const requestData = updatedLicense || { 
                        disableHwid: newState,
                        _id: licenseId,
                        key: licenseId
                    };
                    
                    console.log('Server update with data:', requestData);
                    
                    // Send the complete license object to the server
                    fetch(`${apiUrl}/licenses/${licenseId}`, {
                        method: 'PUT', // Standard RESTful update
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestData)
                    })
                    .then(response => {
                        console.log('Server response status:', response.status);
                        
                        if (!response.ok) {
                            throw new Error(`Server responded with status ${response.status}`);
                        }
                        
                        return response.json().catch(err => {
                            console.warn('Warning: Could not parse response as JSON', err);
                            return { success: true }; // Assume success if we got 200 OK
                        });
                    })
                    .then(data => {
                        console.log('Server update response:', data);
                        showToast(`Hardware ID binding ${newState ? 'disabled' : 'enabled'} successfully`, 'success');
                        
                        // Refresh license data from server if needed
                        setTimeout(() => {
                            const currentAppId = localStorage.getItem('currentAppId');
                            if (currentAppId) {
                                try {
                                    loadLicenses(currentAppId); // Reload licenses tab if needed
                                } catch (e) {
                                    console.log('Note: Licenses tab not active or function not available');
                        }
                            }
                        }, 500);
                    })
                    .catch(error => {
                        console.error('Server update error:', error);
                        
                        // If we at least updated locally, show a warning but not an error
                        if (licenseUpdatedLocally) {
                            showToast(`Hardware ID binding changed locally, but server update failed. Changes may not persist after reload.`, 'warning');
                        } else {
                            showToast(`Error updating Hardware ID binding on server. Please try again.`, 'error');
                        }
                        
                        // Special case for offline mode - show instructions
                        if (!navigator.onLine) {
                            showToast('You appear to be offline. Changes will apply when you reconnect.', 'info');
                        }
                    });
                }
            });
        }
        function copyToClipboard(inputId) {
            var input = document.getElementById(inputId);
            if (input) {
                navigator.clipboard.writeText(input.value)
                    .then(function() {
                        showToast('Copied to clipboard!', 'success');
                    })
                    .catch(function() {
                        showToast('Failed to copy!', 'error');
                    });
            }
        }

        // Disable default context menu and implement custom one
        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            
            const contextMenu = document.getElementById('customContextMenu');
            contextMenu.style.display = 'block';
            contextMenu.style.left = `${e.pageX}px`;
            contextMenu.style.top = `${e.pageY}px`;
            
            // Adjust position if menu would go off screen
            const menuRect = contextMenu.getBoundingClientRect();
            const windowWidth = window.innerWidth;
            const windowHeight = window.innerHeight;
            
            if (e.pageX + menuRect.width > windowWidth) {
                contextMenu.style.left = `${windowWidth - menuRect.width - 10}px`;
            }
            
            if (e.pageY + menuRect.height > windowHeight) {
                contextMenu.style.top = `${windowHeight - menuRect.height - 10}px`;
            }
        });
        
        // Hide context menu when clicking elsewhere
        document.addEventListener('click', function() {
            document.getElementById('customContextMenu').style.display = 'none';
        });
        
        // Add functionality to context menu items
        document.getElementById('refresh').addEventListener('click', function() {
            location.reload();
        });
        
        document.getElementById('back').addEventListener('click', function() {
            history.back();
        });
        
        document.getElementById('forward').addEventListener('click', function() {
            history.forward();
        });
        
        document.getElementById('print').addEventListener('click', function() {
            window.print();
        });
        
        document.getElementById('save').addEventListener('click', function() {
            // This is limited in what it can do due to browser security restrictions
            // but we'll keep it as a menu item for completeness
            alert('Save functionality is limited by browser security.');
        });
        
        // Additional security measures to prevent some inspection features
        document.addEventListener('keydown', function(e) {
            // Prevent F12, Ctrl+Shift+I, Ctrl+Shift+J, Ctrl+Shift+C (developer tools)
            if (
                e.keyCode === 123 || 
                (e.ctrlKey && e.shiftKey && (e.keyCode === 73 || e.keyCode === 74 || e.keyCode === 67))
            ) {
                e.preventDefault();
            }
            
            // Prevent Ctrl+U (view source)
            if (e.ctrlKey && e.keyCode === 85) {
                e.preventDefault();
            }
        });

        // Function to load all licenses for the User Details tab
        function loadLicensesForUserTab() {
            const currentAppId = localStorage.getItem('currentAppId');
            if (!currentAppId) {
                console.error('No application ID found');
                return;
            }
            
            // Use existing methods but update the UI for this tab
            const token = getAuthToken();
            const ownerId = localStorage.getItem('currentOwnerId');
            
            if (!token || !ownerId) {
                console.error('Missing authentication details');
                document.getElementById('no-licenses-found').style.display = 'block';
                return;
            }
            
            const apiUrl = getApiBaseUrl();
            const timestamp = new Date().getTime();
            const url = `${apiUrl}/licenses?ownerId=${ownerId}&appId=${currentAppId}&_t=${timestamp}`;
            
            fetch(url, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Cache-Control': 'no-cache, no-store, must-revalidate',
                    'Pragma': 'no-cache',
                    'Expires': '0'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success && data.data && Array.isArray(data.data)) {
                    renderLicensesInUserTab(data.data);
                } else {
                    // Try local storage as fallback
                    const storedLicenses = JSON.parse(localStorage.getItem(`licenses_${currentAppId}`)) || [];
                    renderLicensesInUserTab(storedLicenses);
                }
            })
            .catch(error => {
                console.error('Error loading licenses:', error);
                // Try local storage as fallback
                const storedLicenses = JSON.parse(localStorage.getItem(`licenses_${currentAppId}`)) || [];
                renderLicensesInUserTab(storedLicenses);
            });
        }
        
        // Function to render licenses in user details tab
        function renderLicensesInUserTab(licenses) {
            const tableBody = document.getElementById('user-licenses-body');
            const noLicensesFound = document.getElementById('no-licenses-found');
            const licenseContainer = document.getElementById('license-list-container');
            
            if (!licenses || licenses.length === 0) {
                licenseContainer.style.display = 'none';
                noLicensesFound.style.display = 'block';
                return;
            }
            
            noLicensesFound.style.display = 'none';
            licenseContainer.style.display = 'block';
            
            tableBody.innerHTML = '';
            
            licenses.forEach(license => {
                // Calculate expiry date
                let expiryDate;
                try {
                    expiryDate = license.expiryDate ? new Date(license.expiryDate) : null;
                    if (!expiryDate || isNaN(expiryDate.getTime())) {
                        // If no valid expiry date, calculate it from creation date and duration
                        const createdDate = license.createdAt ? new Date(license.createdAt) : new Date();
                        const duration = license.duration || 30; // Default to 30 days if missing
                        expiryDate = new Date(createdDate);
                        expiryDate.setDate(expiryDate.getDate() + duration);
                    }
                } catch (e) {
                    console.error('Error calculating expiry date:', e);
                    expiryDate = new Date();
                    expiryDate.setDate(expiryDate.getDate() + 30); // Default to 30 days from now
                }
                
                const now = new Date();
                const isExpired = expiryDate < now;
                const statusClass = isExpired ? 'badge-expired' : 'badge-active';
                const statusText = isExpired ? 'Expired' : 'Active';
                
                // Format duration
                const durationText = formatDuration(
                    license.duration || 30,
                    license.durationType,
                    license.durationValue
                );
                
                // Add to table
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><code>${license.key || 'N/A'}</code></td>
                    <td>${license.name || 'Unnamed'}</td>
                    <td>${durationText}</td>
                    <td><span class="${statusClass}">${statusText}</span></td>
                    <td>
                        <button class="manage-btn" onclick="showLicenseDetails('${license._id || license.key}')">
                            View Details
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        // Function to show license details
        function showLicenseDetails(licenseId) {
            const currentAppId = localStorage.getItem('currentAppId');
            if (!currentAppId || !licenseId) {
                console.error('Missing details for license view');
                return;
            }
            
            // First try finding the license locally
            const storedLicenses = JSON.parse(localStorage.getItem(`licenses_${currentAppId}`)) || [];
            let license = storedLicenses.find(l => (l._id === licenseId) || (l.key === licenseId));
            
            if (license) {
                displayLicenseDetails(license);
                return;
            }
            
            // If not found locally, try API
            const token = getAuthToken();
            const apiUrl = getApiBaseUrl();
            
            fetch(`${apiUrl}/licenses/${licenseId}`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.data) {
                    displayLicenseDetails(data.data);
                } else {
                    showToast('Error loading license details', 'error');
                }
            })
            .catch(error => {
                console.error('Error fetching license details:', error);
                showToast('Error loading license details', 'error');
            });
        }
        
        // Function to display license details
        function displayLicenseDetails(license) {
            const container = document.getElementById('selected-license-details');
            const detailsContainer = document.getElementById('license-details-container');
            
            // Calculate expiry date
            let expiryDate;
            try {
                expiryDate = license.expiryDate ? new Date(license.expiryDate) : null;
                if (!expiryDate || isNaN(expiryDate.getTime())) {
                    // If no valid expiry date, calculate it from creation date and duration
                    const createdDate = license.createdAt ? new Date(license.createdAt) : new Date();
                    const duration = license.duration || 30; // Default to 30 days if missing
                    expiryDate = new Date(createdDate);
                    expiryDate.setDate(expiryDate.getDate() + duration);
                }
            } catch (e) {
                console.error('Error calculating expiry date:', e);
                expiryDate = new Date();
                expiryDate.setDate(expiryDate.getDate() + 30); // Default to 30 days from now
            }
            
            const now = new Date();
            const isExpired = expiryDate < now;
            
            // Determine status based on license status field first, then fallback to expiration check
            let status = license.status || 'inactive';
            if (isExpired && status === 'active') {
                status = 'expired';
            }
            
            // Map status to display text and CSS class
            let statusText, statusClass;
            switch(status) {
                case 'active':
                    statusText = 'Active';
                    statusClass = 'badge-active';
                    break;
                case 'expired':
                    statusText = 'Expired';
                    statusClass = 'badge-expired';
                    break;
                case 'inactive':
                default:
                    statusText = 'Inactive';
                    statusClass = 'badge-expired';
            }
            
            // Get hardware ID - always display it if available, regardless of binding state
            let hardwareId = license.hardwareId || 'Not yet activated';
            
            // Check if hardware ID is disabled
            const isHwidDisabled = license.disableHwid === true;

            container.innerHTML = `
                <div class="user-license-card">
                    <div class="user-license-header">
                        <h4>License Information</h4>
                        <span class="${statusClass}">${statusText}</span>
                    </div>
                    
                    <div class="user-detail-row">
                        <div class="user-detail-label">License Key</div>
                        <div class="user-detail-value"><code>${license.key || 'N/A'}</code></div>
                    </div>
                    
                    <div class="user-detail-row">
                        <div class="user-detail-label">License Name</div>
                        <div class="user-detail-value">${license.name || 'Unnamed License'}</div>
                    </div>
                    
                    <div class="user-detail-row">
                        <div class="user-detail-label">Plan</div>
                        <div class="user-detail-value">${license.plan || 'basic'}</div>
                    </div>
                    
                    <div class="user-detail-row">
                        <div class="user-detail-label">Created Date</div>
                        <div class="user-detail-value">${new Date(license.createdAt || new Date()).toLocaleString()}</div>
                    </div>
                    
                    <div class="user-detail-row">
                        <div class="user-detail-label">Expiry Date</div>
                        <div class="user-detail-value">${expiryDate.toLocaleString()}</div>
                    </div>
                    
                    <div class="user-detail-row">
                        <div class="user-detail-label">Hardware ID Binding</div>
                        <div class="user-detail-value">
                            ${isHwidDisabled 
                                ? '<span class="badge-success">Disabled (Works on All Devices)</span>' 
                                : '<span class="badge-warning">Enabled (Device-Specific)</span>'}
                        </div>
                    </div>
                    
                    ${license.hardwareId && status === 'active' ? `
                    <div class="user-detail-row">
                        <div class="user-detail-label">Hardware ID</div>
                        <div class="user-detail-value hw-id-container">
                            <span class="hw-id-hidden" style="cursor: pointer;" onclick="toggleHardwareIdDisplay(this)">
                                <i class="bi bi-eye"></i> Click to show Hardware ID
                            </span>
                            <span class="hw-id-value" style="display: none;">${hardwareId}</span>
                        </div>
                    </div>
                    ` : `
                    <div class="user-detail-row">
                        <div class="user-detail-label">Hardware ID</div>
                        <div class="user-detail-value">${hardwareId}</div>
                    </div>
                    `}
                    
                    ${license.activationDate ? `
                        <div class="user-detail-row">
                            <div class="user-detail-label">Activation Date</div>
                            <div class="user-detail-value">${new Date(license.activationDate).toLocaleString()}</div>
                        </div>
                    ` : ''}
                    
                    <div class="user-actions">
                        ${!isHwidDisabled ? `
                            <button class="toggle-hwid-btn" onclick="toggleHardwareIdBinding('${license._id || license.key}', ${isHwidDisabled})">
                                <i class="bi bi-unlock"></i> Disable Hardware ID Binding
                            </button>
                        ` : `
                            <button class="toggle-hwid-btn" onclick="toggleHardwareIdBinding('${license._id || license.key}', ${isHwidDisabled})">
                                <i class="bi bi-lock"></i> Enable Hardware ID Binding
                            </button>
                        `}
                    </div>
                </div>
            `;
            
            detailsContainer.style.display = 'block';
        }
        
        // Load licenses for user tab when opening that tab
        document.addEventListener('DOMContentLoaded', function() {
            // Original event listeners remain
            
            // Add event listener for tab navigation
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const tabName = this.getAttribute('onclick').match(/openTab\('(.+?)'\)/)[1];
                    if (tabName === 'user-details') {
                        loadLicensesForUserTab();
                    }
                });
            });
        });

        // Toggle hardware ID display (show/hide)
        function toggleHardwareIdDisplay(element) {
            const container = element.parentNode;
            const hiddenSpan = container.querySelector('.hw-id-hidden');
            const valueSpan = container.querySelector('.hw-id-value');
            
            if (valueSpan.style.display === 'none') {
                // Show hardware ID
                hiddenSpan.style.display = 'none';
                valueSpan.style.display = 'inline';
            } else {
                // Hide hardware ID
                hiddenSpan.style.display = 'inline';
                valueSpan.style.display = 'none';
            }
        }
    </script>
</body>
</html> 